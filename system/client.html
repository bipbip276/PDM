<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta CHARSET="UTF-8">
        <title></title>
        <link rel="icon" href="#">
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <style>
            *{
                scrollbar-width:none;
				outline:none;
                -webkit-tap-highlight-color:rgba(255, 255, 255, 0);/* NON STANDARD! prevent blue highlight on touch where cursor=pointer*/
            }::-webkit-scrollbar{display:none;}/* NON STANDARD! hide scrollbars in blink*/
            html,body{
				font: 12pt "Times New Roman", Times, serif;
                margin:0 auto;
                padding:0;
                width:100%;
                height:100%;
                user-select:none;/*see: userSelectable*/
                overscroll-behavior: none;
                scroll-behavior: auto;/*'smooth': up/down arrows AND click the back-to-top button will be smooth and sluguish. 'auto': up/down arrows AND click the back-to-top button will be choppy/instant. cannot change it on the fly in a simple-enough-for-the-value way */
				border-collapse:collapse;
			}
            input{border:0;padding:0;background-color:transparent;width:100%;height:100%;}
            .userSelectable{}/*see: userSelectable*/

            /*DB:*/
            #DB {z-index:1;}
            #DB_filter{max-width:70em; min-width:20em;margin: 2em auto 3em auto;width:100%;text-align:center;cursor:pointer;border:1px solid grey;border-collapse:collapse;background-color:lightGrey; table-layout: fixed;}
            #DB_filter td{border:1px solid grey;height:3em;overflow-x:hidden;padding:0;}
            #DB_filter_in{width:80%;position:relative;}
            #DB_filter_input{width:100%;height:100%;background-color:white;border:0;}
            #DB_filter_input td{border:0;padding:0em;;height:100%;}
            #DB_filter_input_text{width:100%;}
            #DB_filter_input_text_INPUT{width:100%;height:100%;font-size:1.2em;padding-left:0.5em;}
            #DB_filter_input_clear {min-width:1.5em;height:100%;width:1.5em;font-size:2em;font-weight:normal;vertical-align:middle;color:grey;display:none;}
            #DB_filter_mainMenuContent{display:none;}
            #DB_filter_plugins{display:none;background-color:orange;}
            #DB_lists{}
            #DB_lists .file{display:table;table-layout:fixed;height:100%;width:100%;border-radius:0.2em;background-color:lightGrey;margin:0.5em 0 0.5em 0;border:0px solid grey;box-shadow:0 1px 5px 0 rgba(0, 0, 0, 0.1);}
            #DB_lists .fileEnabled{cursor:pointer;}
            #DB_lists .fileDisabled{cursor:default;}
            #DB_lists .file_ref_date{display:table-cell;vertical-align:middle;text-align:center;min-width:5.6em;border-radius:0.2em 0 0 0.2em;}
            #DB_lists .file_ref_dateRedEnabled{background:repeating-linear-gradient(45deg,#bc606d,#bc606d 10px,#984652 10px,#984652 20px);}
            #DB_lists .file_ref_dateBlueEnabled{background:repeating-linear-gradient(45deg,#606dbc,#606dbc 10px,#465298 10px,#465298 20px);}
            #DB_lists .file_ref_dateBlackEnabled{}
            #DB_lists .file_ref_dateDisabled{}
            #DB_lists .file_ref_name{display:table-cell;vertical-align:middle;text-align:left; padding:0.5em;overflow-wrap: anywhere;width:100%;}/*width 100% is required to let text selection start from the empty right region*/
            #DB_lists .file_ref_nameEnabled{}
            #DB_lists .file_ref_nameDisabled{color:grey;}
            #DB_lists .file_size{display:table-cell;vertical-align:middle;padding-right:0.5em;user-select:none;text-align:right;width:6em;}/*manually exclude these from selection*/
            #DB_lists .file_size_icon{display:inline-block;}
            #DB_lists .file_size_iconRed{color:indianRed;}
            #DB_lists .file_size_iconBlue{color:#606dbc;}
            #DB_lists .file_size_iconBlack{color:black;}
            #DB_lists_reminders{padding-bottom:1em;max-width:70em; min-width:20em;margin:auto;font-size:1em;}
            #DB_lists_desktop{padding-bottom:1em;max-width:70em; min-width:20em;margin:auto;;font-size:1em;}
            #DB_lists_archives{max-width:70em; min-width:20em;margin:auto;;font-size:1em;}
            #DB_lists_archives .file_size{width:7em;text-align:left;}
            #DB_footer {margin:auto;padding-top:3em;height:10em;text-align:center;}
            #DB_footer > div {width: 1em;height: 1em;background-color: #333;border-radius: 100%;display: inline-block;animation: sk-bouncedelay 1.4s infinite ease-in-out both;} @keyframes sk-bouncedelay {0%, 80%, 100% {transform: scale(0);} 40% {transform: scale(1.0);}}
            #DB_footer .DB_footer_bounce1 {animation-delay: -0.32s;margin:0.5em;}
            #DB_footer .DB_footer_bounce2 {animation-delay: -0.16s;margin:0.5em;}
            #DB_footer .DB_footer_bounce3 {margin:0.5em;}

            /*UPLOADER*/
            #UPLOADER {z-index:10;position:fixed;top:0;right:0;height:100%;width:100%;background-color:rgba(0,255,0,0.5);display:none;padding-left:1em;padding-top:0.5em;font-size:1.5em;overflow:hidden;}

            /*VIEWER*/
            #VIEWER {z-index:20;position:fixed;top:0;left:0;right:0;bottom:0;height:100%;width:100%;display:flex;flex-flow: column;background-color:black;color:white;display:none;text-align:center;}
            #VIEWER_menu {flex:0 1 2em; color:white;padding:0;margin:0;font-size:2em;min-height:2em;}
            #VIEWER_menu_main {position:absolute;top:0;left:0;padding:0;margin:0;height:2em;line-height:2em;text-align:left;width:calc( 100vw - 4em);overflow-y:hidden;}
            #VIEWER_menu_main_filename{display:inline-block;font-size:1em;padding:0 0.5em;margin:0;height:100%;min-width:max-content;width:calc(100vw - 11.5em) ;max-width:calc(100vw - 4em);/*width required to start selection from the empty region on the right*/;user-drag: none;white-space: nowrap;}
            #VIEWER_menu_main_filedate{display:inline-block;font-size:1em;padding:0 0em 0 0;margin:0;height:100%;width:5.5em;text-align:center;}
            #VIEWER_menu_close {position:absolute;top:0;right:0;width:2em;height:2em;padding: 0;line-height:2em;cursor:pointer;}
            #VIEWER_menu_actions {position:absolute;top:0;right:2em;width:2em;height:2em;padding: 0;line-height:2em;cursor:pointer;}
            #VIEWER_actions {flex: 0 1 2em;display:flex;justify-content: space-evenly;background-color:green;display:none;font-size:2em;}
            .VIEWER_actions_icon {display:inline-block;cursor:pointer;width:2em;height:2em;line-height:2em;text-shadow: 0 0 3px #FF0000, 0 0 5px #0000FF;}
            #VIEWER_content {flex:1 1 auto;display:flex;overflow-y:scroll;}

            /*EDITOR*/
            #EDITOR {z-index:30;position:fixed;top:0;left:0;right:0;bottom:0;height:100%;width:100%;overflow:hidden;flex-flow:column;background-color:black;color:white;display:none;text-align:center;}
            #EDITOR_menu {flex:0 1 2em;color:white;padding:0;margin:0;font-size:2em;min-height:2em;}
            #EDITOR_menu{background-color:red;height:2em;width:100%;}
            #EDITOR_menu_filename{padding:0;margin:0;width:calc(100vw - 6em);height:2em;white-space:nowrap;overflow:auto;}
            #EDITOR_menu_filename_textInput{width:100%;height:100%;color:white;font-size:1em;margin:0;padding:0 0.5em;}
            #EDITOR_menu_filename_textInput::selection{background-color:white;color:red;}
            #EDITOR_menu_delete{position:absolute;top:0;right:4em;width:2em;height:2em;text-align:center;padding:0;line-height:2em;cursor:pointer;}
            #EDITOR_menu_save{position:absolute;top:0;right:2em;width:2em;height:2em;text-align:center;padding:0;line-height:2em;cursor:pointer;}
            #EDITOR_menu_close{position:absolute;top:0;right:0;width:2em;height:2em;text-align:center;padding:0;line-height:2em;cursor:pointer;}
            #EDITOR_content {flex:1 1 auto;display:flex;overflow-y:scroll;}

        </style>
        <script>
            //### CLIENTSETTINGS #####################################
            //
            // Polling policy
            // The client-page can be configured to do long-polling, Time-fixed polling or no to do polling
            // * Long polling reacts faster to changes on the DB, and execute plugins-daemons with a higher frequency but require a multithreaded DB (not php dead-simple built-in DB)
            // * Time-fixed polling is more reliable and run fine on single thread DBs (such as PHP built-in http DB). Change are detected and plugins-daemons are executed only once at each polling.
            // * No poll: the client is not notified of DB updates unless it does a DB modication, in which case it will recieve the latest update.
            // client_polling variable sets the polling policy:
            // - 0: no polling, WARNING: reminders will only work on manual refresh
            // - any strictly positive int: fixed-time polling (delay between two polling in ms), WARNING: reminders will only work with this granularity, and update will be recieved with this granularity as well
            // - null: make long polls, the max time to respond is determined by the DB.
            client_polling=null;
            // client_polling=60000;

            // Timezone: exclusively client side: files may not have the same date depending where the site is visited from

            //### end of the CLIENTSETTINGS #####################################

            window.onload=function(){
               // console.clear();
                // GO
                DB_init();
                // INFORMATION history management
                // todo...
                history.pushState(true, '','');
                //window.addEventListener('popstate', (event) => {DB_setFilter([],[],'NOW', 'date+'); });
                // INFORMATION userSelectable
                // CSS the all page as not selectable per default (user-select:none)
                // any element that can be selected is in css class '.userSelectable'
                // the functions hereafter allow these element to be fully selected individually with 'ctrl+a'
                // while a click anywhere else does not select but cancels any selection
                window.addEventListener(
                    'mousedown',
                    function(e){
                        if(e.button == 0){
                            var element = e.target.closest('.userSelectable');
                            if(element !==null && element.style.userSelect!=='text'){
                                window.getSelection().removeAllRanges();
                                var exElements=document.getElementsByName('userSelectable_on');
                                if(exElements.length!==0){
                                    exElements[0].style.userSelect='none';
                                    exElements[0].removeAttribute("name");
                                }
                                element.style.userSelect='text';
                                element.name='userSelectable_on';
                                element.setAttribute("name","userSelectable_on");
                            }else{e.stopPropagation();window.getSelection().removeAllRanges();}
                        }
                    },
                    {passive:true}
                );
                window.addEventListener(
                    'touchstart',
                    function(e){
                        var element = e.target.closest('.userSelectable');
                        if(element !==null && element.name!=='userSelectable_on' ){
                            window.getSelection().removeAllRanges();
                            var exElements=document.getElementsByName('userSelectable_on');
                            if(exElements.length!==0){
                                exElements[0].style.userSelect='none';
                                exElements[0].removeAttribute("name");
                            }
                            element.style.userSelect='text';
                            element.name='userSelectable_on';
                            element.setAttribute("name","userSelectable_on");
                        }else{e.stopPropagation();window.getSelection().removeAllRanges();}
                    },
                    {passive:true}
                );
            }

            // DB
            // both the html filter-tool
            // and the core engine that talks to the DB
            // ----------------------------------------
            // actions
            function DB_init(){
                // UI first
                document.getElementById('DB_filter_input_text').oninput=function(e){if(document.getElementById('DB_filter_input_text_INPUT').value==''){document.getElementById('DB_filter_input_clear').style.display='none';DB_setFilter('');}else{document.getElementById('DB_filter_input_clear').style.display='table-cell';DB_setFilter(normalize(document.getElementById('DB_filter_input_text_INPUT').value).split(" "));}}
                document.getElementById('DB_filter_input_text').onkeyup=function(e){if(e.key === 'Enter'){var filename=document.getElementById('DB_filter_input_text_INPUT').value;if(!/^.*\.[0-9a-z]+$/i.test(filename)){filename=filename+'.md';}if(window.confirm('Create file "'+filename+'" ?')){DB_editFileTouch(filename);}}}
                document.getElementById('DB_filter_input_clear').onclick=function(e){document.getElementById('DB_filter_input_text_INPUT').value='';document.getElementById('DB_filter_input_clear').style.display='none';document.getElementById('DB_filter_input_text_INPUT').focus();DB_setFilter('');}
                document.getElementById('DB_filter_mainMenu').onclick=function(){var buttonCSS=document.getElementById('DB_filter_mainMenu').style;var panelCSS=document.getElementById('DB_filter_mainMenuContent').style;var extraButtonCSS=document.getElementById('DB_filter_extraMenu').style;var extraPanelCSS=document.getElementById('DB_filter_plugins').style;if(buttonCSS.backgroundColor==undefined || buttonCSS.backgroundColor=='' || buttonCSS.backgroundColor=='indianred'){buttonCSS.backgroundColor='rgba(0, 0, 0, 0.01)';panelCSS.display='table-row-group';if(extraButtonCSS.backgroundColor=='orange'){extraPanelCSS.display='table-row-group';}}else{extraPanelCSS.display='none';if(DB_filter_ORterms.length != 0 || DB_filter_dateUpTo!='NOW' || DB_filter_sortWay!='date+'){buttonCSS.backgroundColor='indianred';}else{buttonCSS.backgroundColor='';}panelCSS.display='none';}}
                document.getElementById('DB_filter_extraMenu').onclick=function(){var buttonCSS=document.getElementById('DB_filter_extraMenu').style;var panelCSS=document.getElementById('DB_filter_plugins').style;if(buttonCSS.backgroundColor==undefined || buttonCSS.backgroundColor==''){buttonCSS.backgroundColor='orange';panelCSS.display='table-row-group';}else{buttonCSS.backgroundColor='';panelCSS.display='none';}}
                document.getElementById('DB_filter_📷').onclick=function(e){var ORterms=DB_filter_ORterms.slice();var index=ORterms.indexOf('📷');if(index!=-1){ORterms.splice(index,1);e.srcElement.style.backgroundColor='transparent';}else{ORterms.push('📷');e.srcElement.style.backgroundColor='indianred';}DB_setFilter(undefined,ORterms);}
                document.getElementById('DB_filter_🎬').onclick=function(e){var ORterms=DB_filter_ORterms.slice();var index=ORterms.indexOf('🎬');if(index!=-1){ORterms.splice(index,1);e.srcElement.style.backgroundColor='transparent';}else{ORterms.push('🎬');e.srcElement.style.backgroundColor='indianred';}DB_setFilter(undefined,ORterms);}
                document.getElementById('DB_filter_🎵').onclick=function(e){var ORterms=DB_filter_ORterms.slice();var index=ORterms.indexOf('🎵');if(index!=-1){ORterms.splice(index,1);e.srcElement.style.backgroundColor='transparent';}else{ORterms.push('🎵');e.srcElement.style.backgroundColor='indianred';}DB_setFilter(undefined,ORterms);}
                document.getElementById('DB_filter_📄').onclick=function(e){var ORterms=DB_filter_ORterms.slice();var index=ORterms.indexOf('📄');if(index!=-1){ORterms.splice(index,1);e.srcElement.style.backgroundColor='transparent';}else{ORterms.push('📄');e.srcElement.style.backgroundColor='indianred';}DB_setFilter(undefined,ORterms);}
                document.getElementById('DB_filter_📧').onclick=function(e){var ORterms=DB_filter_ORterms.slice();var index=ORterms.indexOf('📧');if(index!=-1){ORterms.splice(index,1);e.srcElement.style.backgroundColor='transparent';}else{ORterms.push('📧');e.srcElement.style.backgroundColor='indianred';}DB_setFilter(undefined,ORterms);}
                document.getElementById('DB_filter_📦').onclick=function(e){var ORterms=DB_filter_ORterms.slice();var index=ORterms.indexOf('📦');if(index!=-1){ORterms.splice(index,1);e.srcElement.style.backgroundColor='transparent';}else{ORterms.push('📦');e.srcElement.style.backgroundColor='indianred';}DB_setFilter(undefined,ORterms);}
                document.getElementById('DB_filter_💻').onclick=function(e){var ORterms=DB_filter_ORterms.slice();var index=ORterms.indexOf('💻');if(index!=-1){ORterms.splice(index,1);e.srcElement.style.backgroundColor='transparent';}else{ORterms.push('💻');e.srcElement.style.backgroundColor='indianred';}DB_setFilter(undefined,ORterms);}
                document.getElementById('DB_filter_👤').onclick=function(e){var ORterms=DB_filter_ORterms.slice();var index=ORterms.indexOf('👤');if(index!=-1){ORterms.splice(index,1);e.srcElement.style.backgroundColor='transparent';}else{ORterms.push('👤');e.srcElement.style.backgroundColor='indianred';}DB_setFilter(undefined,ORterms);}
                document.getElementById('DB_filter_📆').onclick=function(e){var ORterms=DB_filter_ORterms.slice();var index=ORterms.indexOf('📆');if(index!=-1){ORterms.splice(index,1);e.srcElement.style.backgroundColor='transparent';}else{ORterms.push('📆');e.srcElement.style.backgroundColor='indianred';}DB_setFilter(undefined,ORterms);}
                document.getElementById('DB_filter_🔗').onclick=function(e){var ORterms=DB_filter_ORterms.slice();var index=ORterms.indexOf('🔗');if(index!=-1){ORterms.splice(index,1);e.srcElement.style.backgroundColor='transparent';}else{ORterms.push('🔗');e.srcElement.style.backgroundColor='indianred';}DB_setFilter(undefined,ORterms);}
                document.getElementById('DB_filter_📝').onclick=function(e){var ORterms=DB_filter_ORterms.slice();var index=ORterms.indexOf('📝');if(index!=-1){ORterms.splice(index,1);e.srcElement.style.backgroundColor='transparent';}else{ORterms.push('📝');e.srcElement.style.backgroundColor='indianred';}DB_setFilter(undefined,ORterms);}
                document.getElementById('DB_filter_�').onclick=function(e){var ORterms=DB_filter_ORterms.slice();var index=ORterms.indexOf('�');if(index!=-1){ORterms.splice(index,1);e.srcElement.style.backgroundColor='transparent';}else{ORterms.push('�');e.srcElement.style.backgroundColor='indianred';}DB_setFilter(undefined,ORterms);}
                document.getElementById('DB').ondragenter=function(e){e.stopPropagation();e.preventDefault();if(event.dataTransfer.types){for (var i = 0; i < event.dataTransfer.types.length; i++){if(event.dataTransfer.types[i] == "Files"){DB_blur();UPLOADER_open(e);}}}}
                DB_focus();
                // PROCESS after (now, load the data)
                Load1();
                function Load1(){
                    DB_status_initLevel=1;
                    UPLOADER_init();
                    VIEWER_init();
                    EDITOR_init();
                    console.log('INIT 1: starting loading');
                    // send the request to load first packet
                    //#####################################
                    var req = new XMLHttpRequest();
                    req.open('GET','?action=load1',true);
                    req.onreadystatechange = function (){
                        if(req.readyState==XMLHttpRequest.DONE){
                            if(req.status==200){
                                try{var response=JSON.parse(req.responseText);} catch{exit(req.responseText);}
                                DB_settings_icon=response.SETTINGS.icon;
                                DB_settings_name=response.SETTINGS.name;
                                DB_settings_maxFileUploadSize=response.SETTINGS.maxFileUploadSize;
                                DB_settings_plugins=response.PLUGINS;
                                DB_desk_timestamp=response.DESKTOP.timestamp;
                                DB_desk_files=response.DESKTOP.files;
                                DB_arch_timestamp=response.ARCHIVES_LST.timestamp;
                                DB_arch_files=response.ARCHIVES_LST.files;
                                DB_arch_latestfile=DB_arch_files[0];
                                load2();
                            }else{exit('!--- HTML level Error (code '+req.status+')');}
                        }
                    }
                    req.send(null);
                }
                function load2(){
                    DB_status_initLevel=2;
                    console.log('INIT 2: now loading all ARCHIVES');
                    setupPlugins();
                    PAGE_change_title(DB_getName());
                    PAGE_change_favicon(DB_getIcon());
                    DB_setFilter();
                    // send the request to get all the data
                    //#####################################
                    //load all archives
                    var req = new XMLHttpRequest();
                    req.open('GET','?action=load2',true);
                    req.onreadystatechange = function (){
                        if(req.readyState==XMLHttpRequest.DONE){
                            if(req.status==200){
                                try {var response=JSON.parse(req.responseText);} catch{exit(req.responseText);};
                                DB_arch_files=response.ARCHIVES.files;
                                DB_arch_latestfile=DB_arch_files[0];
                                DB_arch_oldestfile=DB_arch_files[DB_arch_files.length-1];
                                DB_arch_timestamp=response.ARCHIVES.timestamp;
                                daemon();
                            }else{exit('!--- HTML level Error (code '+req.status+')');}
                        }
                    }
                    req.send(null);
                }
                function daemon(){
                    //TODO sort desk once in for all
                    DB_status_initLevel=3;
                    console.log('INIT 3: now launching daemon');
                    removeLoadingSpinner();
                    setupDateInput();
                    setupSortInput();
                    DB_focus();
                    DB_setFilter();//just in case there was a change between load1 and load2
                    // send the request to get potential updates from DB
                    //#####################################
                    window.addEventListener('online',  function(){console.log('Back online');DB_status_online=true;DB_send();});
                    window.addEventListener('offline', function(){console.log('Going offline');DB_status_online=false;});
                    DB_send();
                }
                function setupPlugins(){
                    //#######################
                    // Install plugins
                    //#######################
                    var htmlTable='';
                    var htmlRow='';
                    var row_counter=0;
                    for (const plugin of DB_settings_plugins){if(row_counter==5){htmlTable=htmlTable+"<tr>"+htmlRow+"</tr>";htmlRow='';row_counter=0;}htmlRow=htmlRow+"<td onmousedown='event.preventDefault();window.open(\""+plugin['plugin']+"\");' >"+plugin['pluginName']+"</td>";row_counter++;}
                    if(row_counter!=0){while(row_counter!=5){htmlRow=htmlRow+"<td>&nbsp;</td>";row_counter++;}htmlTable=htmlTable+"<tr>"+htmlRow+"</tr>";}
                    document.getElementById('DB_filter_plugins').innerHTML=htmlTable;
                }
                function setupDateInput(){
                    //#######################
                    // set "Date up to" input
                    //#######################
                    var year= new Date().getFullYear();
                    var oldestYear=year;
                    var oldestYear=DB_FILE_getDate(DB_getArchOldestfile()).getFullYear();
                    var HTML="<option value=\"ALL\">📅 Show all</option>";
                    HTML=HTML+"<option value=\"NOW\" selected=\"selected\" style=\"font-weight:bold;\">Up to now</option>";
                    while (year!=oldestYear){year--;HTML=HTML+"<option value=\""+(year+1)+"\">Up to "+year+"</option>";}
                    document.getElementById('DB_filter_dateUpTo').innerHTML="<select style='margin:0;padding:0;border:0;background-color:transparent;height:100%;width:100%;position:relative;left:0;' size='1'>"+HTML+"</select>";
                    document.getElementById('DB_filter_dateUpTo').children[0].onchange=function(e){
                        switch(this.value){
                            case 'NOW':document.getElementById('DB_filter_dateUpTo').style.backgroundColor='transparent';DB_setFilter(undefined,undefined,'NOW');break;
                            case 'ALL':document.getElementById('DB_filter_dateUpTo').style.backgroundColor='indianred';DB_setFilter(undefined,undefined,'ALL');break;
                            default:document.getElementById('DB_filter_dateUpTo').style.backgroundColor='indianred';DB_setFilter(undefined,undefined,new Date(this.value,0,0,0,0,0,0));
                        }
                    }
                }
                function setupSortInput(){
                    var HTML="";
                    HTML=HTML+"<option value='date+' style='font-weight:bold;'>Sort by date</option>";
                    HTML=HTML+"<option value='date-'>Sort by date -</option>";
                    HTML=HTML+"<option value='size+'>Sort by size</option>";
                    HTML=HTML+"<option value='size-'>Sort by size -</option>";
                    HTML=HTML+"<option value='reshufl'>Shuffle</option>";
                    HTML=HTML+"<option value='shufl' hidden>Shuffle</option>";
                    HTML="<select style='margin:0;padding:0;border:0;background-color:transparent;height:100%;width:100%;position:relative;left:0;' size='1'>"+HTML+"</select>";
                    document.getElementById('DB_filter_sortWay').innerHTML=HTML;
                    document.getElementById('DB_filter_sortWay').children[0].onchange=function(e){switch(this.value){case'date+':document.getElementById('DB_filter_sortWay').style.backgroundColor='transparent';break;case 'reshufl':this.value='shufl';default:document.getElementById('DB_filter_sortWay').style.backgroundColor='indianred';}DB_setFilter(undefined,undefined,undefined,this.value);}
                }
                function removeLoadingSpinner(){
                    document.getElementById('DB_footer').innerHTML='';
                }
            }
            function DB_focus(){
                //document.body.style.overflow='';// to avoid wheel on other layers to scroll through. solution from: https://medium.com/jsdownunder/locking-body-scroll-for-all-devices-22def9615177
                //document.getElementById('DB_lists').style.visibility='';does not work
                //if desktop give the focus to the search field
                //preventScroll: true: to avoid the page scrolling back to the search field at the top
                //I dont do it in mobile environment to avoid having the virtual keyboard popping
                PAGE_key_set("CTRL_s",false);
                PAGE_key_set("PageUp",function(){window.scrollBy({top:-window.innerHeight,behavior:"auto"});});
                PAGE_key_set("PageDown",function(){window.scrollBy({top: window.innerHeight,behavior:"auto"});});
                PAGE_key_set("ArrowUp",function(){window.scrollBy({top:-window.innerHeight,behavior:"smooth"});});
                PAGE_key_set("ArrowDown",function(){window.scrollBy({top: window.innerHeight,behavior:"smooth"});});
                PAGE_key_set("Home",function(){window.scrollTo({top: 0,behavior:"auto"});document.getElementById('DB_filter_input_text_INPUT').focus();});
                PAGE_key_set("Escape",function(){window.scrollTo({top: 0,behavior:"auto"});document.getElementById('DB_filter_input_text_INPUT').focus();document.getElementById('DB_filter_input_clear').click();});
                //focus on the search field (no important on mobiles) - yet it should not scroll back to the field
                if(!PAGE_isMobile()){document.getElementById('DB_filter_input_text_INPUT').focus({preventScroll: true});}
                document.body.style.overflowY='';document.body.onscroll= function(e){/* blur input to hide the keyboard on mobile devices*/if(PAGE_isMobile()){document.activeElement.blur();}/*Add more rows if scrolled to the end*/if(document.documentElement.scrollTop + document.documentElement.clientHeight >= document.documentElement.scrollHeight-600){DB_setFilter(undefined,undefined,undefined,undefined,DB_arch_list.length+20);}}
            }
            function DB_editFile(file,stat,date,name,data){
                //file
                // * a desktop file
                //stat
                // * '*': desktop unread
                // * ':': desktop read
                //date
                //* a JS date
                //* undefined: date unchanged
                //name
                // * a valid name
                // * undefined: name unchanged
                //data
                // * undefined: data unchanged if referenceChanged / null if created
                // * array ['method'=>'archiveCopy','archiveCopy'=><archive reference>]
                // * array ['method'=>'textData',       'textData'=><text data>]
                // * array ['method'=>'fileData',       'fileData'=><file>]
                if(date===undefined){date=DB_FILE_getDate(file);}
                if(stat===undefined){stat=DB_FILE_getStat(file);}
                if(name===undefined){name=DB_FILE_getName(file);}
                var destinationReference=DATE_getTimestamp14(date)+stat+name;
                if(destinationReference==file.reference && data==undefined){return false;}
                var get='?action=edit&sourceReference='+encodeURIComponent(file.reference)+'&destinationReference='+encodeURIComponent(destinationReference);
                // adjusting data
                if(data==undefined){
                    var post=null;
                    var size=file.size;
                }
                else{
                    get=get+'&method='+encodeURIComponent(data.method);
                    switch(data.method){
                        case 'textData':var post=new FormData();post.append('textData',data.textData);var size=stringsize(data.textData);break;
                        case 'fileData':var post=new FormData();post.append('fileData',data.fileData);var size=data.fileData.size;break;
                        default:exit('Error in DB_editFile: unrocognized data.method');
                    }
                }
                var sendPacket={
                    get: get,
                    post: post,
                    visiblePlaceholderFile: {stat:'-',date:date,name:name,size:size},
                    hiddenPlaceholderFile: file
                };
                DB_send(sendPacket);
                return true;
            }
            function DB_editFileTouch(name){
                //name: a valid desktop file name
                var stat=':';
                var date=new Date();
                var name=name;
                var size='0';
                var destinationReference=DATE_getTimestamp14(date)+stat+name;
                // Add request to the queue
                DB_send({
                    get: '?action=edit&destinationReference='+encodeURIComponent(destinationReference),
                    post: null,
					visiblePlaceholderFile: {stat:'-',date:date,name:name,size:size},
                    hiddenPlaceholderFile: null
                });
                return true;
            }
            function DB_editFileUpload(JSfile){
                //name: a valide desktop file name
                var stat=':';
                var date=new Date();
                var name=JSfile.name;
                var size=JSfile.size;
                var destinationReference=DATE_getTimestamp14(date)+stat+name;
                // Add request to the queue
                var post=new FormData();
                post.append('fileData',JSfile);
                DB_send({
                    get: '?action=edit&destinationReference='+encodeURIComponent(destinationReference)+'&method=fileData',
                    post: post,
                    visiblePlaceholderFile: {stat:'-',date:date,name:name,size:size},
                    hiddenPlaceholderFile: null
                });
                return true;
            }
            function DB_editFileRead(file){
                // Will: make it a 'read' desktop file at the files's date if the file's date is in the past
                // Will: make it a 'read' desktop file at 'now' if the file's is in the future.
                // Will: return false if nothing was changed.
                // * file: a desktop file (file.stat=='*' or file.stat==':')
                //************************************
                var stat=':';
                var date=DB_FILE_getDate(file);const now=new Date();if(date>now){date=now;}
                var name=DB_FILE_getName(file);
				var size=DB_FILE_getSize(file);
                var destinationReference=DATE_getTimestamp14(date)+stat+name;
                if(destinationReference==file.reference){return false;}
                // Add request to the queue
                DB_send({
                    get: '?action=edit&sourceReference='+encodeURIComponent(file.reference)+'&destinationReference='+encodeURIComponent(destinationReference),
                    post: null,
                    visiblePlaceholderFile: {stat:'-',date:date,name:name,size:size},
                    hiddenPlaceholderFile: file
				});
                return true;
            }
            function DB_editFileUnread(file){
                // Will: unread the file (file.stat=='*') after offering the user to set a date
                // Will: return false if their was no change (file was already unread or if the user cancelled)
                // * file: a desktop file (file.stat==':' || file.stat=='*')
                //************************************
                var stat='*';
                var date=null;
                while(date==null){var strDate=prompt("⏰ Remind you ?",DATE_getHumanDateFormat(new Date(),19));if(strDate==null){return false;}var date=DATE_setHumanDateFormat(strDate);if(date==null){alert('Date not recognized');}}
                var name=DB_FILE_getName(file);
				var size=DB_FILE_getSize(file);
                var destinationReference=DATE_getTimestamp14(date)+stat+name;
                if(destinationReference==file.reference){return false;}
                // Add request to the queue
                DB_send({
                    get: '?action=edit&sourceReference='+encodeURIComponent(file.reference)+'&destinationReference='+encodeURIComponent(destinationReference),
                    post: null,
                    visiblePlaceholderFile: {stat:'-',date:date,name:name,size:size},
                    hiddenPlaceholderFile: file
                });
                return true;
            }
            function DB_editFileDelete(file){
                // Will: offer the user a chance to cancel then delete the file
                // Will: return false if file was NOT deleted
                // * file: a desktop file (file.stat=='*' or file.stat==':')
                //************************************
                // Offer the user a chance to cancel
                if(!window.confirm('Delete file?')){return false;}
                //**********************************************
                // Add request to the queue
                var sendPacket={
                    get:'?action=edit&sourceReference='+encodeURIComponent(file.reference),
                    post: null,
                    visiblePlaceholderFile: null,
                    hiddenPlaceholderFile: file
                };
                DB_send(sendPacket);
                return true;
            }
            function DB_registerFile(file){
                // Will: move file from Desktop to Archives
                // Will: return false if action was cancelled
                // * file: a desktop file (file.stat==':' || file.stat=='*') 
                //************************************
                var stat=' ';
                var date=new Date();
                var name=prompt("Archive file?",DB_FILE_getName(file));if(name==null){return false;}//cancelled
				var size=DB_FILE_getSize(file);
                var destinationReference=DATE_getTimestamp14(date)+stat+name;
                // Add request to the queue
                DB_send({
                    get:'?action=register&sourceReference='+encodeURIComponent(file.reference)+'&destinationName='+encodeURIComponent(name),
                    post: null,
                    visiblePlaceholderFile:{stat:'_',date:new Date(date.getTime() + 10000),name:name,size:size},//note: we add 10s (client max latency) to avoid jitter since the final date will be the one determined by the DB
                    hiddenPlaceholderFile: file
                });
                return true;
            }
            function DB_copybackFile(file){
                // Will: make a copy the archives file in Desktop
                // Will: always return true
                // * file: an archive file (file.stat==' ') 
                //************************************
                var stat=':';
                var date=new Date();
                var name=DB_FILE_getName(file);
				var size=DB_FILE_getSize(file);
                var destinationReference=DATE_getTimestamp14(date)+stat+name;
                // Add request to the queue
                DB_send({
                    get:'?action=copyback&sourceReference='+encodeURIComponent(file.reference)+'&destinationReference='+encodeURIComponent(destinationReference),
                    post: null,
                    visiblePlaceholderFile: {stat:'-',date:date,name:name,size:size},
                    hiddenPlaceholderFile: null
                });
                return true;
            }
            function DB_checkoutFile(file){
                // * file: a desktop file (file.stat=='*' or file.stat==':')
                // Will: download the desktop file, and then propose the user to delete it
                DB_FILE_download(file,function (){DB_editFileDelete(file);});
            }
            // Access
            function DB_getIcon(){
                return DB_settings_icon;
            }
            function DB_getName(){
                return DB_settings_name;
            }
            function DB_getMaxFileUploadSize(){
                return DB_settings_maxFileUploadSize;
            }
            function DB_getDeskList(){
                return DB_desk_list;
            }
            function DB_getArchList(grow=false){
                // if grow==false: returns the arch list (at least default_minLen items)
                // if grow==true: try to grow the arch list; return it if successful, return null otherwise
                if(grow){
                    var l=DB_arch_list.length;
                    DB_setFilter(undefined,undefined,undefined,undefined,DB_arch_list.length+20);
                    if(DB_arch_list.length==l){return null;}
                }
                return DB_arch_list;
            }
            function DB_getArchOldestfile(){
                if(DB_status_initLevel<3){exit('Error function DB_getArchOldestfile cannot be called before stage 3');}
                return DB_arch_oldestfile;
            }
            function DB_getArchLatestfile(){
                if(DB_status_initLevel<3){exit('Error function DB_getArchOldestfile cannot be called before stage 3');}
                return DB_arch_latestfile;
            }
            function DB_FILE_getReference(file){
                return file.reference;
            }
            function DB_FILE_getStat(file){
                // returns '*': desktop unread                           (reference's 15th character='*')
                // returns ':': desktop read                             (reference's 15th character=':')
                // returns '-': desktop visible placeholder (precreated)
                // returns '~': desktop hidden placeholder (predeleted)
                // returns ' ': archive                                  (reference's 15th character=' ')
                // returns '_': archive visible placeholder (precreated)
                if(!file.hasOwnProperty('stat')){
                    // since the DB garanties the regular pattern: [\d\-]\d\d\d\d\d\d\d\d\d\d\d\d[*: ](.*){1,240}
                    // and locally we respect the following patter:    [\d\-]\d\d\d\d\d\d\d\d\d\d\d\d[*: -~_](.*){1,240}
                    file.date=new Date(parseInt(file.reference.slice(0,14)));
                    file.stat=file.reference.charAt(14);
                    file.name=file.reference.slice(15);
                }
                return file.stat;
            }
            function DB_FILE_getDate(file){
                // * returns 'NOW' if desktop file does not respect the naming conventions
                // * returns a JS date otherwise
                if(!file.hasOwnProperty('stat')){DB_FILE_getStat(file);}
                return file.date;
            }
            function DB_FILE_getName(file){
                // * returns filename (string min 1 char, max 240 char)
                if(!file.hasOwnProperty('stat')){DB_FILE_getStat(file);}
                return file.name;
            }
            function DB_FILE_getSize(file){
                return file.size;
            }
            function DB_FILE_getUnicId(file){
                // a unic html-valid element ID that can be usefull
                // will be used for temp files (to callback "onProgress" in a simple manner)
                if(!file.hasOwnProperty('unicId')){
                    //file.unicId=btoa(file.reference); btoa does not work with unicode characters
                    //simple has function from: https://stackoverflow.com/questions/6122571/simple-non-secure-hash-function-for-javascript on 2022-06-12
                    let hash = 0;
                    for (let i = 0, len = file.reference.length; i < len; i++) {
                        let chr = file.reference.charCodeAt(i);
                        hash = (hash << 5) - hash + chr;
                        hash |= 0; // Convert to 32bit integer
                    }
                    file.unicId=hash;
                }
                return file.unicId;
            }
            function DB_FILE_getTextSize(file){
                if(!file.hasOwnProperty('textSize')){
                    file.textSize=bytesToHumansize(DB_FILE_getSize (file));
                }
                return file.textSize;
            }
            function DB_FILE_getTextDate(file){
                if(!file.hasOwnProperty('textDate')){
                    if(DB_FILE_getDate(file)===undefined){file.textDate='';}
                    else{file.textDate=new Date(DB_FILE_getDate(file).getTime()-(DB_FILE_getDate(file).getTimezoneOffset()*60000)).toISOString().split('T')[0];}//not using lib function to go fast
                }
                return file.textDate;
            }
            function DB_FILE_getTextName(file){
                if(!file.hasOwnProperty('textName')){
                    file.textName=DB_FILE_getName(file);
                }
                return file.textName;
            }
            function DB_FILE_getHTMLSize(file){
                if(!file.hasOwnProperty('htmlSize')){
                    file.htmlSize=DB_FILE_getTextSize(file);
                }
                return file.htmlSize;
            }
            function DB_FILE_getHTMLDate(file){
                if(!file.hasOwnProperty('htmlDate')){
                    file.htmlDate=DB_FILE_getTextDate(file);
                }
                return file.htmlDate;
            }
            function DB_FILE_getHTMLName(file){
                if(!file.hasOwnProperty('htmlName')){
                    file.htmlName=str2HTML(DB_FILE_getTextName(file));
                }
                return file.htmlName;
            }
            function DB_FILE_getExtension(file){
                if(!file.hasOwnProperty('extension')){
                    var filename=DB_FILE_getName (file);
                    var n=filename.lastIndexOf(".");
                    if(n<0){file.extension='';}
                    else{file.extension=filename.slice(n+1).toLowerCase();}
                }
                return file.extension;
            }
            function DB_FILE_getMime(file){
                if(!file.hasOwnProperty('mime')){
                    var extension=DB_FILE_getExtension(file);
                    if(!DB_filesTypes.hasOwnProperty(extension)){extension=null;}
                    file.mime=DB_filesTypes[extension].mime;
                }
                return file.mime;
            }
            function DB_FILE_getCategory(file){
                if(!file.hasOwnProperty('category')){
                    var extension=DB_FILE_getExtension(file);
                    if(!DB_filesTypes.hasOwnProperty(extension)){extension=null;}
                    file.category=DB_filesTypes[extension].category;
                }
                return file.category;
            }
            function DB_FILE_getBin(file){
                if(!file.hasOwnProperty('bin')){
                    var extension=DB_FILE_getExtension(file);
                    if(!DB_filesTypes.hasOwnProperty(extension)){extension=null;}
                    file.bin=DB_filesTypes[extension].bin;
                }
                return file.bin;
            }
            function DB_FILE_getPotentialArchivedDuplicate(file){
                //returns null if size <1000 (1Kb) or if no archive file has the same size
                //returns the first file with the exact same size otherwise
                //Note: it will find itself if run on an ARCHIVES file
                var fileSize=DB_FILE_getSize(file);
                if(fileSize>1000){
                    const found = DB_arch_files.find(otherfile => otherfile.size == fileSize);
                    if(found==undefined){return null;}else{return found;}
                }
                else{return null;}
            }
            function DB_FILE_getLookupref(file){
                if(!file.hasOwnProperty('searchref')){
                    file.searchref=normalize(file.reference);
                }
                return file.searchref;
            }
            function DB_FILE_getHref(file){
                if(!file.hasOwnProperty('href')){
                    switch(DB_FILE_getStat(file)){
                        case ':':
                        case '*':file.href='?action=desktop_get&sourceReference='+encodeURIComponent(file.reference)+'&t='+new Date().getTime();break;
                        case ' ':file.href='?action=archives_get&sourceReference='+encodeURIComponent(file.reference);break;
                        case '-':
                        case '~':
                        case '_':
                        default:file.href='';exit('Error cannot get href for temp files or file stat unknown');
                    }
                }
                return file.href;
            }
            function DB_FILE_download(file,onsend){
                // Will: download the archive file
                // * file: a ' ' archive file
                //************************************
                var a = document.createElement('A');
                a.href=DB_FILE_getHref(file);
                switch(DB_FILE_getStat(file)){
                    case '*':
                    case ':':
                        //for desktop files, we remove the date, files are attemporal, it also prevent issue if a file is dragged back in after being edited
                        a.download=DB_FILE_getName(file);
                        break;
                    case ' ':
                        //for archived files, we keep the all reference the date, files are timestamped, since it is not compliant to the desktop standard format, there wont be issues if the fiels is dragged back in (the timestamp will be treated as name)
                        a.download=file.reference;
                        break;
                    case '-':
                    case '~':
                    case '_':
                    default: exit('file stat not recognized in DB_FILE_download');
                }
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                // on a linux DB, once the downloading starts,
                // if the file is deleted, it will wait for the download to end
                // so, onsend request can be sent now, it will arrive after the download started.
                if(onsend!==undefined){setTimeout(onsend,100);}
                return true;
            }
            function DB_FILE_downloadContent(file,callBack){
                // returns the text content as a string for '📝' files
                // returns true for binary files
                // it returns the value as the argument of the callback function
                if(!file.hasOwnProperty('fileCont')){
                    var ext=DB_FILE_getExtension(file);
                    var knownTextFormats= ['txt','md','csv','sh','php','js','json','c','h','py','link','eml','contact','vcf','vcard'];
                    var r=true;
                    if(!knownTextFormats.includes(ext)){r = confirm("Warning, downloading a non-text file?");}
                    if(file.size>50000000){r = confirm("Warning, downloading an extremely large text file?");}
                    if(r){
                        var request = new XMLHttpRequest();
                        var cachebreaker='';if(DB_FILE_getStat(file)!==' '){cachebreaker='&t='+new Date().getUTCMilliseconds();}
                        request.open('GET',DB_FILE_getHref(file)+cachebreaker,true);
                        request.onreadystatechange=function(){
                            if(request.readyState === 4){
                                if(request.status === 200){
                                    if(DB_FILE_getStat(file)==' '){file.fileCont=request.responseText;}// cache content for archives only
                                    callBack(request.responseText);
                                }
                                else{exit('Error while retrieving file content. status: '+request.status+' uri was: '+DB_FILE_getHref(file));}
                            }
                        }
                        request.send(null);
                    }
                    else{
                        file.fileCont=null;
                        callBack(file.fileCont);
                    }
                }
                else{callBack(file.fileCont);}
            }
            function DB_FILE_printHTMLContent(file,element){
                //fills element with html content for file
                if(DB_FILE_getBin(file)===true){
                    // We will simply produce (sync) a page that links the file
                    switch(DB_FILE_getCategory(file)){
                        case '🎵':
                            element.innerHTML=''+
                            '<div style="width:100%;height:100%;display:flex;align-items:center;">'+
                            '    <div id="VIEWER_streamer_visu" style="margin:auto;color:white;padding:2em 0;cursor:pointer;text-align:center;border-radius:0.5em;background-color:DarkSlateGray;width:360px;" onclick="apply_autoPlay(true)">'+
                            '        <div style="font-size:10em;">🎵</div>'+
                            '        <audio id="VIEWER_streamer" controls preload="metadata" onvolumechange="apply_volume(this.volume);" style="max-width: 330px;" ><source src="'+DB_FILE_getHref(file)+'" alt=""></audio>'+
                            '    </div>'+
                            '</div>';
                        break;
                        case '📷':
                            element.innerHTML='<img id="VIEWERer" src="'+DB_FILE_getHref(file)+'" alt="" style="object-fit:scale-down;width:100%;height:100%;"/>';
                        break;
                        case '🎬':
                            element.innerHTML=''+
                            '<div style="width:100%;height:100%;display:flex;align-items:center;">'+
                            '    <div id="VIEWER_streamer_visu" style="margin:auto;color:white;padding:2em 0 ;cursor:pointer;text-align:center;border-radius:0.5em;width:360px;" onclick="apply_autoPlay(true)">'+
                            '        <div></div>'+
                            '        <video id="VIEWER_streamer" onvolumechange="apply_volume(this.volume)" controls preload="metadata" style="height:20em;max-width: 330px;"><source src="'+DB_FILE_getHref(file)+'" alt=""></video>'+
                            '    </div>'+
                            '</div>';
                        break;
                        default:
                            if(DB_FILE_getExtension(file)=='pdf'){
                                //hugly workaround but embedding pdf is so handy and <object> tag falls back downloading on other file types
                                element.innerHTML=''+
                                '<object data=\"'+DB_FILE_getHref(file)+'#toolbar=0&navpanes=0&scrollbar=0\" type=\"application/pdf\" width=\"100%\" height=\"100%\">'+
                                '    <div style="width:100%;height:100%;display:flex;align-items:center;">'+
                                '        <a style="margin:auto;border-radius:0.5em;display:inline-block;background-color:grey;padding:4em;text-align:center;color:white;font-size:1em;text-decoration: none;" href="'+DB_FILE_getHref(file)+'" alt="'+decodeURIComponent(DB_FILE_getHref(file))+'" target="_blank">'+
                                '            <div style="font-size:5em;padding:0.5em;">'+DB_FILE_getCategory(file)+'</div>'+
                                '        </a>'+
                                '    </div>'+
                                '</object>';
                            }
                            else{
                                element.innerHTML=''+
                                '<div style="width:100%;height:100%;display:flex;align-items:center;">'+
                                '    <a style="margin:auto;border-radius:0.5em;display:inline-block;background-color:grey;padding:4em;text-align:center;color:white;font-size:1em;text-decoration: none;" href="'+DB_FILE_getHref(file)+'" alt="'+decodeURIComponent(DB_FILE_getHref(file))+'" target="_blank">'+
                                '        <div style="font-size:5em;padding:0.5em;">'+DB_FILE_getCategory(file)+'</div>'+
                                '    </a>'+
                                '</div>';
                            }
                    }
                }
                else{
                    // There is a JS method to process the data, we will make an async request then print a page that includes the file content
                    var unicID = (new Date()).getTime().toString();
                    element.innerHTML='<div id="wait'+unicID+'" style="width:100%;height:100%;"><div style="position:relative;top:50%;font-size:3em">⏱...</div></div>';
                    DB_FILE_downloadContent(
                        file,
                        function(data){
                            if(document.getElementById("wait"+unicID)){
                                element.innerHTML='<div id="viewbox" style="margin:0 auto;background-color:white;text-align:left;padding:2em;max-width:70em;color:black;overflow:auto;">'+DB_FILE_getBin(file)(data)+'</div>';
                                document.getElementById('viewbox').classList.add("userSelectable");
                            }//else: outdated request, the div was already overwitten
                        }
                    );
                }
            }
            // DB PRIVATE variables and functions
			// DB settings
			var DB_settings_name=null;
			var DB_settings_icon=null;
			var DB_settings_plugins=null;
			var DB_settings_maxFileUploadSize=0;
			// DB internal status variables
			var DB_status_online=true;
            var DB_status_initLevel=0;// 0:not started 1:started 2:first packet 3:loading completed, updateDaemon started
            var DB_status_sendQueue=[];
			// DB user filter
			var DB_filter_ANDterms=[];// array of strings that should all be present in the filename to be in lists
			var DB_filter_ORterms=[];// array of strings that any of which should be present in the filename to be in lists
			var DB_filter_dateUpTo='NOW';// 'ALL' 'NOW' or JS date in the past
			var DB_filter_sortWay='date+';// sort order ('date+', 'date-', 'size+', or 'size-', or 'shufl')
			var DB_filter_listLen=30;// length of the list for archives
			// DB data
			var DB_desk_timestamp=0;
			var DB_desk_files=[];
			var DB_desk_list=[];//filtered
			var DB_arch_timestamp=0;
			var DB_arch_files=[];
			var DB_arch_list=[];//filtered
			var DB_arch_oldestfile=null;
			var DB_arch_latestfile=null;
			var DB_arch_defaultListLen=30;//default length of filtered list
			var DB_arch_moreIndex=0;//stores the index of the last file of the list
			// DB constants
            var DB_filesTypes={// category can be: '📝', '💻', '📄', '📧', '📦', '👤', '📆', '🔗', '📷', '🎬', '🎵', '�' (12 categories)
                'txt':    {'category':'📝','bin':txt2HTML ,'mime':'text/plain'},
                'md':     {'category':'📝','bin':md2HTML  ,'mime':'text/markdown'},
                'csv':    {'category':'📝','bin':txt2HTML ,'mime':'text/csv'},
                'php':    {'category':'💻','bin':code2HTML,'mime':'text/plain'},
                'json':   {'category':'💻','bin':code2HTML,'mime':'text/plain'},
                'conf':   {'category':'💻','bin':code2HTML,'mime':'text/plain'},
                'js':     {'category':'💻','bin':code2HTML,'mime':'text/plain'},
                'sh':     {'category':'💻','bin':code2HTML,'mime':'application/x-sh'},
                'c':      {'category':'💻','bin':code2HTML,'mime':'text/plain'},
                'h':      {'category':'💻','bin':code2HTML,'mime':'text/plain'},
                'py':     {'category':'💻','bin':code2HTML,'mime':'text/plain'},
                'css':    {'category':'💻','bin':code2HTML,'mime':'text/plain'},
                'xml':    {'category':'💻','bin':code2HTML,'mime':'text/plain'},
                'html':   {'category':'📄','bin':html2HTML,'mime':'text/html'},
                'htm':    {'category':'📄','bin':html2HTML,'mime':''},
                'html':   {'category':'📄','bin':html2HTML,'mime':''},
                'mhtml':  {'category':'📄','bin':true    ,'mime':''},
                'pdf':    {'category':'📄','bin':true    ,'mime':'application/pdf'},
                'doc':    {'category':'📄','bin':true    ,'mime':''},
                'docx':   {'category':'📄','bin':true    ,'mime':''},
                'ppt':    {'category':'📄','bin':true    ,'mime':'application/vnd.ms-powerpoint'},
                'pptx':   {'category':'📄','bin':true    ,'mime':'application/vnd.openxmlformats-officedocument.presentationml.presentation'},
                'xls':    {'category':'📄','bin':true    ,'mime':'application/vnd.ms-excel'},
                'xlsx':   {'category':'📄','bin':true    ,'mime':'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'},
                'ps':     {'category':'📄','bin':true    ,'mime':''},
                'rtf':    {'category':'📄','bin':true    ,'mime':'text/rtf'},
                'tex':    {'category':'📄','bin':true    ,'mime':''},
                'sxw':    {'category':'📄','bin':true    ,'mime':''},
                'odt':    {'category':'📄','bin':true    ,'mime':''},
                'odf':    {'category':'📄','bin':true    ,'mime':''},
                'ods':    {'category':'📄','bin':true    ,'mime':''},
                'xlsm':   {'category':'📄','bin':true    ,'mime':''},
                'eml':    {'category':'📧','bin':eml2HTML,'mime':''},
                'mbox':   {'category':'📧','bin':true    ,'mime':''},
                'msg':    {'category':'📧','bin':true    ,'mime':''},
                'pst':    {'category':'📧','bin':true    ,'mime':''},
                'zip':    {'category':'📦','bin':true    ,'mime':'application/zip'},
                'iso':    {'category':'📦','bin':true    ,'mime':''},
                'tar':    {'category':'📦','bin':true    ,'mime':''},
                '7z':     {'category':'📦','bin':true    ,'mime':''},
                'rar':    {'category':'📦','bin':true    ,'mime':'application/vnd.rar'},
                'gzip':   {'category':'📦','bin':true    ,'mime':''},
                'bzip':   {'category':'📦','bin':true    ,'mime':''},
                'gz':     {'category':'📦','bin':true    ,'mime':''},
                'taz':    {'category':'📦','bin':true    ,'mime':'application/x-tar'},
                'bz2':    {'category':'📦','bin':true    ,'mime':''},
                'xz':     {'category':'📦','bin':true    ,'mime':''},
                'tgz':    {'category':'📦','bin':true    ,'mime':''},
                'contact':{'category':'👤','bin':md2HTML  ,'mime':''},
                'vcf':    {'category':'👤','bin':md2HTML  ,'mime':''},
                'vcard':  {'category':'👤','bin':md2HTML  ,'mime':''},
                'event':  {'category':'📆','bin':md2HTML  ,'mime':''},
                'ical':   {'category':'📆','bin':true    ,'mime':'text/calendar'},
                'xcal':   {'category':'📆','bin':true    ,'mime':''},
                'hcal':   {'category':'📆','bin':true    ,'mime':''},
                'vcal':   {'category':'📆','bin':true    ,'mime':''},
                'ics':    {'category':'📆','bin':txt2HTML ,'mime':'text/calendar'},
                'link':   {'category':'🔗','bin':txt2HTML ,'mime':''},
                'url':    {'category':'🔗','bin':txt2HTML ,'mime':''},
                'desktop':{'category':'🔗','bin':txt2HTML ,'mime':''},
                'jpeg':   {'category':'📷','bin':true    ,'mime':'image/jpeg'},
                'jpg':    {'category':'📷','bin':true    ,'mime':'image/jpeg'},
                'gif':    {'category':'📷','bin':true    ,'mime':'image/gif'},
                'png':    {'category':'📷','bin':true    ,'mime':'image/png'},
                'webp':   {'category':'📷','bin':true    ,'mime':'image/webp'},
                'svg':    {'category':'📷','bin':true    ,'mime':'image/svg+xml'},
                'ppm':    {'category':'📷','bin':true    ,'mime':''},
                'tiff':   {'category':'📷','bin':true    ,'mime':'image/tiff'},
                'tif':    {'category':'📷','bin':true    ,'mime':'image/tiff'},
                'bmp':    {'category':'📷','bin':true    ,'mime':'image/bmp'},
                'mp4':    {'category':'🎬','bin':true    ,'mime':'image/mp4'},
                'avi':    {'category':'🎬','bin':true    ,'mime':'video/x-msvideo'},
                'webm':   {'category':'🎬','bin':true    ,'mime':'video/webm'},
                'mpg':    {'category':'🎬','bin':true    ,'mime':'video/mpeg'},
                'mpeg':   {'category':'🎬','bin':true    ,'mime':'video/mpeg'},
                'mkv':    {'category':'🎬','bin':true    ,'mime':''},
                'flv':    {'category':'🎬','bin':true    ,'mime':''},
                'vob':    {'category':'🎬','bin':true    ,'mime':''},
                'ogv':    {'category':'🎬','bin':true    ,'mime':'video/ogg'},
                'mov':    {'category':'🎬','bin':true    ,'mime':''},
                'qt':     {'category':'🎬','bin':true    ,'mime':''},
                'rm':     {'category':'🎬','bin':true    ,'mime':''},
                'mp2':    {'category':'🎬','bin':true    ,'mime':''},
                '3gp':    {'category':'🎬','bin':true    ,'mime':'video/3gpp'},
                '3g2':    {'category':'🎬','bin':true    ,'mime':'video/3gpp'},
                'f4v':    {'category':'🎬','bin':true    ,'mime':''},
                'm4v':    {'category':'🎬','bin':true    ,'mime':''},
                'ts':     {'category':'🎬','bin':true    ,'mime':'video/mp2t'},
                'mp3':    {'category':'🎵','bin':true    ,'mime':'audio/mpeg'},
                'flac':   {'category':'🎵','bin':true    ,'mime':'audio/mpeg'},
                'ogg':    {'category':'🎵','bin':true    ,'mime':'audio/ogg'},
                'wav':    {'category':'🎵','bin':true    ,'mime':'audio/wav'},
                'gsm':    {'category':'🎵','bin':true    ,'mime':''},
                'aa':     {'category':'🎵','bin':true    ,'mime':''},
                'aac':    {'category':'🎵','bin':true    ,'mime':''},
                'aax':    {'category':'🎵','bin':true    ,'mime':''},
                'mod':    {'category':'🎵','bin':true    ,'mime':''},
                'xm':     {'category':'🎵','bin':true    ,'mime':''},
                null:     {'category':'�' ,'bin':true    ,'mime':''}
            }
            function DB_send(sendPacket=null){
                // no arguments: process the next packet
                // sendPacket: add it to the queue:
                // {
                //     get: <string: the get argument>,
                //     post: <formdata: the post argument> or NULL if none,
                //     visiblePlaceholderFile: NULL or {stat:<stat>,date:<date>,name:<name>,size:<size>} to be displayed as a place holder
                //     hiddenPlaceholderFile: NULL or file to hide
                // }
                //
                // the queue "DB_status_sendQueue" is an array of objects:
                // {
                //     get: <string: the get argument>,
                //     post: <formdata: the post argument> or NULL if none,
                //     visiblePlaceholderFile: NULL or {stat:<stat>,date:<date>,name:<name>,size:<size>} to be displayed as a place holder
                //     hiddenPlaceholderFile: NULL or file to hide
                //     
                //     (optionnally only the for the [0] first in queue):
                //     pending: the pending request xmlhttprequest (user)
                //     pendingLP: the pending request xmlhttprequest (system long poll)
                //     pendingPP: a timestamp (system periodic poll)
                
                
                if(sendPacket==null){//no arguments => process next
                    if(DB_status_sendQueue.length==0){
                        switch(client_polling){
                            case 0: // no polling policy, just let the queue die, empty
                                break; 
                            case null: // long poll policy, add a long poll packet and send it
                                DB_status_sendQueue.push({get:'?action=loadUpdateLongpoll&timestamp_DESKTOP='+DB_desk_timestamp+'&timestamp_ARCHIVES='+DB_arch_timestamp,post:null,visiblePlaceholderFile:null,hiddenPlaceholderFile:null});
                                DB_send();
                                break;
                            default: // periodic poll policy, add a poll packet and send it later if the timestamp is still in
                                var timestamp=Date.now();
                                DB_status_sendQueue.push({get:'?action=loadUpdate',post:null,visiblePlaceholderFile:null,hiddenPlaceholderFile:null,pending:timestamp});
                                setTimeout(function(){if(DB_status_sendQueue[0].hasOwnProperty('pending') && DB_status_sendQueue[0].pending==timestamp){DB_send();}},client_polling);
                        }
                    }
                    else{
                        var request=DB_status_sendQueue[0];
                        //we can call:
                        // * request.get
                        // * request.post
                        // * request.visiblePlaceholderFile
                        // * request.hiddenPlaceholderFile
                        DB_status_sendQueue[0].pending=new XMLHttpRequest();
                        DB_status_sendQueue[0].pending.open('POST',request.get,true);
                        DB_status_sendQueue[0].pending.upload.onprogress=function(oEvent){if(request.visiblePlaceholderFile!==null){var visiblePlaceholderElement=document.getElementById(DB_FILE_getUnicId(request.visiblePlaceholderFile));if(visiblePlaceholderElement!==null){visiblePlaceholderElement.innerText='⚙ ( '+Math.round(oEvent.loaded/oEvent.total * 100)+' % )';}}}
                        DB_status_sendQueue[0].pending.onreadystatechange = function (){
                            if(DB_status_sendQueue[0].pending.readyState==XMLHttpRequest.DONE){
                                switch(DB_status_sendQueue[0].pending.status){
                                    case 200:
                                        console.log ('++++> DB replied');
                                        try {var responseFS=JSON.parse(DB_status_sendQueue[0].pending.responseText);}
                                        catch {console.log(DB_status_sendQueue[0].pending.responseText);location.reload();/*exit('DB returned invalid string, please refresh the window.');*/return false;};//most likely logged out uncomment for debugging
                                        //process update part of the responseFS here
                                        var needRefresh=false;
                                        if(responseFS.hasOwnProperty('DESKTOP') && responseFS.DESKTOP.timestamp>DB_desk_timestamp){//heree, timestamp may be unchanged
                                            // 1 delete the visible placeholder if any
                                            if(request.visiblePlaceholderFile!==null){DB_desk_files.splice(DB_desk_files.findIndex(x => x.reference === request.visiblePlaceholderFile.reference),1);}
                                            // 2 delete the hidden placeholder if any
                                            if(request.hiddenPlaceholderFile!==null){DB_desk_files.splice(DB_desk_files.findIndex(x => x.reference === request.hiddenPlaceholderFile.reference),1);}
                                            // 3 collect all the other placeholders (unconcerned by this transaction)
                                            DB_desk_files=DB_desk_files.filter(function(file){var filestat=DB_FILE_getStat(file);return (filestat=='-'||filestat=='~')});
                                            // 4 inject back the received DESKTOP files
                                            DB_desk_files=DB_desk_files.concat(responseFS.DESKTOP.files);
                                            // 5 update timestamp
                                            DB_desk_timestamp=responseFS.DESKTOP.timestamp;
                                            // 6 notify
                                            needRefresh=true;
                                        }
                                        if(responseFS.hasOwnProperty('ARCHIVES_LST') && responseFS.ARCHIVES_LST.timestamp>DB_arch_timestamp){
                                            // 1 delete the visible placeholder if any
                                            if(request.visiblePlaceholderFile!==null){DB_arch_files.splice(DB_arch_files.findIndex(x => x.reference === request.visiblePlaceholderFile.reference),1);}
                                            // 2 top-up ARCHIVES files with the latest received
                                            var lastRef=DB_getArchLatestfile().reference;
                                            var i=0;
                                            while(responseFS.ARCHIVES_LST.files[i].reference!=lastRef){
                                                DB_arch_files.unshift(responseFS.ARCHIVES_LST.files[i]);
                                                if(DB_FILE_getDate(DB_arch_files[0])>DB_FILE_getDate(DB_arch_latestfile)){DB_arch_latestfile=DB_arch_files[0];}
                                                i++;
                                                if(i==responseFS.ARCHIVES_LST.files.length){exit('More than 100 files archived since the last update. This situation is not managed. Please refresh manually');}
                                            }
                                            // 3 update timestamp
                                            DB_arch_timestamp=responseFS.ARCHIVES_LST.timestamp;
                                            // 4 notify
                                            needRefresh=true;
                                        }
                                        if(needRefresh){DB_setFilter();}
                                        DB_status_sendQueue.shift();
                                        DB_send();
                                    break;
                                    case 0:
                                        console.log ('===== cancelled long poll request');
                                    break;
                                    case 504:
                                        console.log ('===== gateway timeout');
                                        alert('gateway timeout. Daemon stopped');
                                    break;
                                    default:
                                        console.log ('====! HTTP communication error status: '+DB_status_sendQueue[0].pending.status);
                                        alert('HTTP communication error: check console. Daemon stopped');
                                }
                                //if(DB_status_online){DB_send();}else{console.log('daemon stopped');}
                            }
                        }
                        DB_status_sendQueue[0].pending.send(request.post);
                        console.log ('<---- Send DB request');
                    }
                }
                else{//add the packet to the queue
					if(sendPacket.visiblePlaceholderFile!==null){
						// insert the placeholder in the files list (file.stat='-' or '_')
                        if(sendPacket.visiblePlaceholderFile.name.length>240){exit('Error 127');return false;}
						sendPacket.visiblePlaceholderFile.reference=DATE_getTimestamp14(sendPacket.visiblePlaceholderFile.date)+sendPacket.visiblePlaceholderFile.stat+sendPacket.visiblePlaceholderFile.name;
						switch(sendPacket.visiblePlaceholderFile.stat){
							case '-':DB_desk_files.unshift(sendPacket.visiblePlaceholderFile);DB_desk_files.sort(function(a,b){return DB_FILE_getDate(b)-DB_FILE_getDate(a);});break;
							case '_':DB_arch_files.unshift(sendPacket.visiblePlaceholderFile);break;
							default:exit('Error 126');
						}
					}
					if(sendPacket.hiddenPlaceholderFile!==null){sendPacket.hiddenPlaceholderFile.stat='~';}// change the file stat to '~' so it wont be shown while still around waiting for deletion
                    DB_status_sendQueue.push(sendPacket);
                    DB_setFilter();
                    if(DB_status_sendQueue.length>1 && DB_status_sendQueue[0].get.search('loadUpdate')!=-1){
                        if(client_polling==null){
                            DB_status_sendQueue[0].pending.abort();
                            DB_status_sendQueue.shift();
                            DB_send();
                        }
                        else if(client_polling!==0){
                            // periodic polling (with period "client_polling"
                            // just delete the first packet
                            // and process the next one (the timestamp in "DB_status_sendReq" will be overwritten and so the timeout/promise will not send anything.
                            DB_status_sendQueue.shift();
                            DB_send();
                        }
                    }
                }
            }
            function DB_setFilter(ANDterms,ORterms,dateUpTo,sortWay,listLen){
                // this function asks the DB to update the lists (filtered version of the data on the DB)
                // (filtering parameters should be provided only if a change occured, otherwise provide 'undefined')

                // What is does
                // ------------
                // Internally, the following DB variables will be refreshed:
                // * DB_desk_list (filtered down items from DB_desk_files)
                // * DB_arch_list (filtered down items from DB_arch_files)

                var refreshMode=0;
                //0 do nothing
                //1 refresh only on filters: ANDterms, ORterms, dateUpTo (listLen->default)
                //2 refresh only on filters: ANDterms, ORterms, dateUpTo, sortway (listLen->default)
                //3 refresh only on filters: listLen
                //x refresh on all filters: ANDterms, ORterms, dateUpTo, sortway, listLen
                if(arguments.length==0){
                    refreshMode=1;
                }
                else{
                    if(ANDterms!==undefined && ANDterms!==DB_filter_ANDterms){
                        DB_filter_ANDterms=ANDterms;
                        refreshMode=1;
                    }
                    if(ORterms!==undefined && ORterms!==DB_filter_ORterms){
                        DB_filter_ORterms=ORterms;
                        refreshMode=1;
                    }
                    if(dateUpTo!==undefined && dateUpTo!==DB_filter_dateUpTo){
                        DB_filter_dateUpTo=dateUpTo;
                        refreshMode=1;
                    }
                    if((sortWay!==undefined)){
                        //can be re-triggered
                        DB_filter_sortWay=sortWay;
                        refreshMode=2;
                    }
                    if(listLen!==undefined && listLen>DB_filter_listLen){
                        DB_filter_listLen=listLen;
                        if(refreshMode==0){refreshMode=3;}else{refreshMode='X';}
                    }
                }
                switch(refreshMode){
                    case 1:
                        DB_filter_listLen=DB_arch_defaultListLen;
                        proc_all();
                        refreshLists();
                    break;
                    case 2:
                        DB_filter_listLen=DB_arch_defaultListLen;
                        sort_arch();
                        proc_all();
                        refreshLists();
                    break;
                    case 3: 
                        proc_archExtend();
                        refreshLists();
                    break;
                    case 'X':
                        sort_arch();
                        proc_all();
                        refreshLists();
                    break;
                    case 0:
                    default:
                }
                function sort_arch(){
                    switch(DB_filter_sortWay){
                        case 'date+':DB_arch_files.sort(function(a,b){return DB_FILE_getDate(b)-DB_FILE_getDate(a);});break;
                        case 'date-':DB_arch_files.sort(function(b,a){return DB_FILE_getDate(b)-DB_FILE_getDate(a);});break;
                        case 'size+':DB_arch_files.sort(function(a,b){return b.size-a.size;});break;
                        case 'size-':DB_arch_files.sort(function(b,a){return b.size-a.size;});break;
                        case 'shufl':var tmp,cur,top=DB_arch_files.length;if(top)while(--top){cur=Math.floor(Math.random()*(top+1));tmp=DB_arch_files[cur];DB_arch_files[cur]=DB_arch_files[top];DB_arch_files[top]=tmp;};break;
                        default:exit('invalid sortway: '+DB_filter_sortWay);
                    }
                }
                function proc_all(){
                    switch(DB_filter_dateUpTo){
                        case 'ALL':
                            compute_list_desk_dateUpToIgnore();
                            compute_list_arch_dateUpToIgnore();
                        break;
                        case 'NOW':
                            compute_list_desk_dateUpToIsNoww();
                            compute_list_arch_dateUpToIgnore();
                        break;
                        default:
                            compute_list_desk_dateUpToIsPast();
                            compute_list_arch_dateUpToIsPast();
                    }
                }
                function proc_archExtend(){
                    switch(DB_filter_dateUpTo){
                        case 'ALL':
                        case 'NOW':compute_list_arch_dateUpToIgnore(true);
                        break;
                        default:compute_list_arch_dateUpToIsPast(true);
                    }
                }
                function compute_list_desk_dateUpToIgnore(){
                    //use this if you want to skip filtering on dateUpTo (='ALL')
                    //speedway#
                    DB_desk_list=[];
                    var searchedstring,index=0,file,i;
                    while(index<DB_desk_files.length){
                        i=0;
                        file=DB_desk_files[index];
                        searchedstring=DB_FILE_getLookupref (file);
                        //first we filter on DB_filter_ANDterms to get rid of the maximum of negative (most discrimitative)
                        while(i<DB_filter_ANDterms.length){
                            if(searchedstring.indexOf(DB_filter_ANDterms[i])<0){i=DB_filter_ANDterms.length+1;}
                            else{i++;}
                        }
                        if(i==DB_filter_ANDterms.length){
                            //second we filter on DB_filter_ORterms
                            if(DB_filter_ORterms.length==0 || DB_filter_ORterms.indexOf(DB_FILE_getCategory(DB_desk_files[index]))!=-1){
                                DB_desk_list.push(DB_desk_files[index]);
                            }//else{console.log('filtered on ORterms');}
                        }//else{console.log('filtered on ANDterms');}
                        index++;
                    }
                }
                function compute_list_desk_dateUpToIsNoww(){
                    //use this if you want to filter with dateUpTo ='NOW'
                    var dateUpTo=new Date();
                    //speedway#
                    DB_desk_list=[];
                    var searchedstring,index=0,file,date,i;
                    while(index<DB_desk_files.length){
                        i=0;
                        file=DB_desk_files[index];
                        searchedstring=DB_FILE_getLookupref (file);
                        date=DB_FILE_getDate(file);
                        //first we filter on DB_filter_ANDterms to get rid of the maximum of negative (most discrimitative)
                        while(i<DB_filter_ANDterms.length){
                            if( searchedstring.indexOf(DB_filter_ANDterms[i])<0){i=DB_filter_ANDterms.length+1;}
                            else{i++;}
                        }
                        if(i==DB_filter_ANDterms.length){
                            //second we filter on or terms
                            if(DB_filter_ORterms.length==0 || DB_filter_ORterms.indexOf(DB_FILE_getCategory(DB_desk_files[index]))!=-1){
                                //lastly we filter on DB_filter_dateUpTo: 99% of the time positive since we rarely change the chronological order that is default
                                if(date<=dateUpTo || date=='NOW'){
                                    DB_desk_list.push(DB_desk_files[index]);
                                }//else{console.log('filtered on date');}
                            }//else{console.log('filtered on ORterms');}
                        }//else{console.log('filtered on ANDterms');}
                        index++;
                    }
                }
                function compute_list_desk_dateUpToIsPast(){
                    //use this if you want to filter with a dateUpTo that is a past date AND you are certain that the deck does not have dates in the future or 'NOW'
                    //speedway#
                    DB_desk_list=[];
                    var searchedstring,index=0,file,date,i;
                    while(index<DB_desk_files.length){
                        i=0;
                        file=DB_desk_files[index];
                        searchedstring=DB_FILE_getLookupref(file);
                        date=DB_FILE_getDate(file);
                        //first we filter on DB_filter_ANDterms to get rid of the maximum of negative (most discrimitative)
                        while(i<DB_filter_ANDterms.length){
                            if( searchedstring.indexOf(DB_filter_ANDterms[i])<0){i=DB_filter_ANDterms.length+1;}
                            else{i++;}
                        }
                        if(i==DB_filter_ANDterms.length){
                            //second we filter on or terms
                            if(DB_filter_ORterms.length==0 || DB_filter_ORterms.indexOf(DB_FILE_getCategory(DB_desk_files[index]))!=-1){
                                //lastly we filter on DB_filter_dateUpTo: 99% of the time positive since we rarely change the chronological order that is default
                                if(date<=DB_filter_dateUpTo){
                                    DB_desk_list.push(DB_desk_files[index]);
                                }//else{console.log('filtered on date');}
                            }//else{console.log('filtered on ORterms');}
                        }//else{console.log('filtered on ANDterms');}
                        index++;
                    }
                }
                function compute_list_arch_dateUpToIgnore(FromIndex){
                    if(FromIndex===undefined){
                        DB_arch_list=[];
                        DB_arch_moreIndex=0;
                    }
                    //speedway#
                    var searchedstring,file;
                    while(DB_arch_list.length<DB_filter_listLen && DB_arch_moreIndex<DB_arch_files.length){
                        i=0;
                        file=DB_arch_files[DB_arch_moreIndex];
                        searchedstring=DB_FILE_getLookupref (file);
                        //first we filter on DB_filter_ANDterms to get rid of the maximum of negative (most discrimitative)
                        while(i<DB_filter_ANDterms.length){
                            if( searchedstring.indexOf(DB_filter_ANDterms[i])<0){i=DB_filter_ANDterms.length+1;}
                            else{i++;}
                        }
                        if(i==DB_filter_ANDterms.length){
                            //second we filter on or terms
                            if(DB_filter_ORterms.length==0 || DB_filter_ORterms.indexOf(DB_FILE_getCategory(DB_arch_files[DB_arch_moreIndex]))!=-1){
                                DB_arch_list.push(DB_arch_files[DB_arch_moreIndex]);
                            }//else{console.log('filtered on ORterms');}
                        }//else{console.log('filtered on ANDterms');}
                        DB_arch_moreIndex++;
                    }
                }
                function compute_list_arch_dateUpToIsPast(FromIndex){
                    if(FromIndex===undefined){
                        DB_arch_list=[];
                        DB_arch_moreIndex=0;
                    }
                    //speedway#
                    var searchedstring,file,date,i;
                    while(DB_arch_list.length<DB_filter_listLen && DB_arch_moreIndex<DB_arch_files.length){
                        i=0;
                        file=DB_arch_files[DB_arch_moreIndex];
                        searchedstring=DB_FILE_getLookupref (file);
                        date=DB_FILE_getDate(file);
                        //first we filter on DB_filter_ANDterms to get rid of the maximum of negative (most discrimitative)
                        while(i<DB_filter_ANDterms.length){
                            if( searchedstring.indexOf(DB_filter_ANDterms[i])<0){i=DB_filter_ANDterms.length+1;}
                            else{i++;}
                        }
                        if(i==DB_filter_ANDterms.length){
                            //second we filter on or terms
                            if(DB_filter_ORterms.length==0 || DB_filter_ORterms.indexOf(DB_FILE_getCategory(DB_arch_files[DB_arch_moreIndex]))!=-1){
                                //lastly we filter on DB_filter_dateUpTo: 99% of the time positive since we rarely change the chronological order that is default
                                if(date<=DB_filter_dateUpTo){
                                    DB_arch_list.push(DB_arch_files[DB_arch_moreIndex]);
                                }//else{console.log('filtered on date');}
                            }//else{console.log('filtered on ORterms');}
                        }//else{console.log('filtered on ANDterms');}
                        DB_arch_moreIndex++;
                    }
                }
                function refreshLists(){
                    //tokens
                    var file,HTMLfilename, HTMLfiledate, HTMLfilesize, html, rank;
                    const now=new Date();
                    //refresh desktop
                    html_reminders='';
                    html_desktop='';
                    html_archives='';
                    rank=0;
                    while(rank<DB_desk_list.length){
                        file=DB_desk_list[rank];
                        if(DB_FILE_getDate(file)>now){
                            switch(DB_FILE_getStat(file)){
                                case ':':
                                case '*':
									html_reminders=
									'<div class="file fileEnabled">'+
									'  <div class="file_ref" onmouseup="if(!window.getSelection().toString()){if(event.button==1){window.open(DB_FILE_getHref(DB_desk_list['+rank+']));}else{DB_blur();VIEWER_open(DB_desk_list['+rank+'],false,false);}}">'+
									'    <div class="file_ref_date file_ref_dateRedEnabled userSelectable">'+DB_FILE_getHTMLDate(file)+'</div>'+
									'    <div class="file_ref_name file_ref_nameEnabled userSelectable">'+DB_FILE_getHTMLName(file)+'</div>'+
									'  </div>'+
									'  <div class="file_size">'+
									'    <div class="file_size_icon file_size_iconBlue" onclick="DB_editFileRead(DB_desk_list['+rank+']);">▼</div>'+
									'    <div class="file_size_icon file_size_iconBlack" onclick="DB_blur();EDITOR_open(DB_desk_list['+rank+'],false,false);">✍</div>'+
									'    <div class="file_size_icon file_size_iconBlack" onclick="DB_checkoutFile(DB_desk_list['+rank+']);">➥</div>'+
									'  </div>'+
									'</div>'+html_reminders;
                                break;
                                case '-':
									html_reminders=
                                    '<div class="file fileDisabled">'+
                                    '  <div class="file_ref">'+
                                    '    <div class="file_ref_date file_ref_dateDisabled userSelectable" id="'+DB_FILE_getUnicId(file)+'">...</div>'+
                                    '    <div class="file_ref_name file_ref_nameDisabled userSelectable">'+DB_FILE_getHTMLName(file)+'</div>'+
                                    '  </div>'+
                                    '  <div class="file_size">&nbsp;</div>'+
                                    '</div>'+html_reminders;
                                break;
								case '~':
                                break;
                                default:exit('Error 125'+DB_FILE_getStat(file));
							}
                        }
                        else{
                            switch(DB_FILE_getStat(file)){
                                case ':':
                                    html_desktop=html_desktop+
                                    '<div class="file fileEnabled">'+
                                    '  <div class="file_ref" onmouseup="if(!window.getSelection().toString()){if(event.button==1){window.open(DB_FILE_getHref(DB_desk_list['+rank+']));}else{DB_blur();VIEWER_open(DB_desk_list['+rank+'],false,false);}}">'+
                                    '    <div class="file_ref_date file_ref_dateBlueEnabled userSelectable">'+DB_FILE_getHTMLDate(file)+'</div>'+
                                    '    <div class="file_ref_name file_ref_nameEnabled userSelectable">'+DB_FILE_getHTMLName(file)+'</div>'+
                                    '  </div>'+
                                    '  <div class="file_size">'+
                                    '    <div class="file_size_icon file_size_iconRed" onclick="DB_editFileUnread(DB_desk_list['+rank+']);">▲</div>'+
                                    '    <div class="file_size_icon file_size_iconBlack" onclick="DB_registerFile(DB_desk_list['+rank+']);">▼</div>'+
                                    '    <div class="file_size_icon file_size_iconBlack" onclick="DB_blur();EDITOR_open(DB_desk_list['+rank+'],false,false);">✍</div>'+
                                    '    <div class="file_size_icon file_size_iconBlack" onclick="DB_checkoutFile(DB_desk_list['+rank+']);">➥</div>'+
                                    '  </div>'+
                                    '</div>';
                                break;
                                case '*':
                                    html_desktop=html_desktop+
                                    '<div class="file fileEnabled" onmouseup="if(!window.getSelection().toString()){DB_editFileRead(DB_desk_list['+rank+']);}">'+
                                    '  <div class="file_ref">'+
                                    '    <div class="file_ref_date file_ref_dateRedEnabled userSelectable">'+DB_FILE_getHTMLDate(file)+'</div>'+
                                    '    <div class="file_ref_name file_ref_nameEnabled userSelectable">'+DB_FILE_getHTMLName(file)+'</div>'+
                                    '  </div>'+
                                    '  <div class="file_size">'+
                                    '  </div>'+
                                    '</div>';
                                break;
                                case '-':
                                    html_desktop=html_desktop+
                                    '<div class="file fileDisabled">'+
                                    '  <div class="file_ref">'+
                                    '    <div class="file_ref_date file_ref_dateDisabled userSelectable" id="'+DB_FILE_getUnicId(file)+'">...</div>'+
                                    '    <div class="file_ref_name file_ref_nameDisabled userSelectable">'+DB_FILE_getHTMLName(file)+'</div>'+
                                    '  </div>'+
                                    '  <div class="file_size">&nbsp;</div>'+
                                    '</div>';
                                break;
								case '~':
                                break;
                                default:exit('Error 123');
                            }
                        }
                        rank++;
                    }
                    if(html_reminders!==''){document.getElementById('DB_lists_reminders').innerHTML=html_reminders+'<hr>';document.getElementById('DB_lists_reminders').style.display='block';}else{document.getElementById('DB_lists_reminders').style.display='none';}
                    document.getElementById('DB_lists_desktop').innerHTML=html_desktop;
                    rank=0;
                    while(rank!=DB_arch_list.length){
                        file=DB_arch_list[rank];
                        switch(DB_FILE_getStat(file)){
                            case ' ':
                                html_archives=html_archives+
                                '<div class="file fileEnabled">'+
                                '  <div class="file_ref" onmouseup="if(!window.getSelection().toString()){if(event.button==1){window.open(DB_FILE_getHref(DB_arch_list['+rank+']));}else{DB_blur();VIEWER_open(DB_arch_list['+rank+'],false,false);}}">'+
                                '    <div class="file_ref_date file_ref_dateBlackEnabled userSelectable">'+DB_FILE_getHTMLDate(file)+'</div>'+
                                '    <div class="file_ref_name file_ref_nameEnabled userSelectable">'+DB_FILE_getHTMLName(file)+'</div>'+
                                '  </div>'+
                                '  <div class="file_size">'+
                                '    <div class="file_size_icon file_size_iconBlue" onclick="DB_copybackFile(DB_arch_list['+rank+']);">⧋</div>'+
                                // we have a valid link with href (that makes it dragable), but onclick: preventDefault(); (...); is to prevent the browser from opening the link an do the intended JS action instead
                                '    <a class="file_size_icon" href="'+DB_FILE_getHref(file)+'" onclick="event.preventDefault();DB_FILE_download(DB_arch_list['+rank+']);return false;">📥 '+DB_FILE_getHTMLSize(file)+'</a>'+
                                '  </div>'+
                                '</div>';
                            break;
                            case '_':
                                html_archives=html_archives+
                                '<div class="file file fileDisabled">'+
                                '  <div class="file_ref">'+
                                '    <div class="file_ref_date file_ref_dateDisabled userSelectable" id="'+DB_FILE_getUnicId(file)+'">...</div>'+
                                '    <div class="file_ref_name file_ref_nameDisabled userSelectable">'+DB_FILE_getHTMLName(file)+'</div>'+
                                '  </div>'+
                                '  <div class="file_size">&nbsp;</div>'+
                                '</div>';
                            break;
                            default:exit('Error 124');
                        }
                        rank++;
                    }
                    document.getElementById('DB_lists_archives').innerHTML=html_archives;
                }
            }
            function DB_blur(){
                PAGE_key_set("PageDown",true);
                PAGE_key_set("PageUp",true);
                PAGE_key_set("ArrowDown",true);
                PAGE_key_set("ArrowUp",true);
                PAGE_key_set("Home",false);
                PAGE_key_set("Escape",false);
                document.body.style.overflowY='hidden';
                document.body.onscroll= function(e){};
            }

            // UPLOADER
            // --------
            function UPLOADER_init(){
                document.getElementById('UPLOADER').ondrop=function(e){
                    e.stopPropagation();
                    e.preventDefault();
                    document.getElementById('UPLOADER').style.display='none';
                    DB_focus();
                    UPLOADER_handleDrop(e.dataTransfer.files);
                    return false;
                }
                document.getElementById('UPLOADER').ondragleave=function(e){
                    e.stopPropagation();
                    e.preventDefault();
                    DB_focus();
                    document.getElementById('UPLOADER').style.display='none';
                }
                document.getElementById('UPLOADER').ondragover=function(e){
                    e.preventDefault();
                }
            }
            function UPLOADER_open(e){
                document.getElementById('UPLOADER').innerText="Max: "+bytesToHumansize(DB_getMaxFileUploadSize());
                document.getElementById('UPLOADER').style.display='block';
            }
            // UPLOADER PRIVATE variables and functions
            var UPLOADER_filesqueue=[];//List of files to upload
            var UPLOADER_req=false;
            function UPLOADER_handleDrop(files){
                for(var i=0;i<files.length;i++){
                    async function uploadIfFile(file) {
                        try {
                            await file.slice(0,1).arrayBuffer();// force an error if it is not a regular file
                            if(file.size<DB_getMaxFileUploadSize()){
                                DB_editFileUpload(file);
                            }else{alert('File is too large to upload here (max: '+bytesToHumansize(SERVER_getMaxFileUploadSize())+')');}
                        }catch(err){alert('Cannot upload folders');}
                    }
                    uploadIfFile(files[i]);
                }
            }

            // VIEWER
            // ------
            function VIEWER_init(){
                document.getElementById('VIEWER_menu_main_filename').classList.add("userSelectable");
                document.getElementById('VIEWER_menu_main_filedate').classList.add("userSelectable");
                document.getElementById('VIEWER_menu_actions').onclick=function(){apply_actionsMenu(true);}
                document.getElementById('VIEWER_menu_close').onclick=VIEWER_action_close;
            }
            function VIEWER_open(file){
                VIEWER_load(file);
            }
            // VIEWER PRIVATE variables and functions
            var VIEWER_autoPlay=false;        // is autoplay active (<boolean>)
            var VIEWER_volume=1;              // a number between 0 and 1 or a string of that number (muted)
            var VIEWER_actionsMenu=false;     // is actionMenu bar opened (<boolean>)
            var VIEWER_list=[];
            var VIEWER_rank=-1;
            function VIEWER_load(file){
                switch(DB_FILE_getStat(file)){
                    case '*': case ':':VIEWER_loadDesk(file);break;
                    case ' ': VIEWER_loadArch(file);break;
                    case '~': case '-': case '_': default: exit('Errror in VIEWER_open cannot recognise stat:'+DB_FILE_getStat(file));
                }
                function VIEWER_loadDesk(file){
                    VIEWER_list=DB_getDeskList().filter(function(file){var stat=DB_FILE_getStat(file);return stat==':'|| stat=='*';});//we filterout temp files
                    PAGE_key_set("Escape",function(){VIEWER_action_close();});
                    PAGE_key_set("i",function(){VIEWER_action_infos();});
                    PAGE_key_set("ArrowUp",function(){VIEWER_action_viewprev();});
                    PAGE_key_set("ArrowLeft",function(){VIEWER_action_viewprev();});
                    PAGE_key_set("ArrowDown",function(){VIEWER_action_viewnext();});
                    PAGE_key_set("ArrowRight",function(){VIEWER_action_viewnext();});
                    PAGE_key_set(" ",function(){VIEWER_action_streamTogglePlayPause();});
                    PAGE_key_set("e",VIEWER_action_edit);
                    PAGE_key_set("d",VIEWER_action_download);
                    PAGE_key_set("CTRL_s",VIEWER_action_download);
                    PAGE_key_set("Delete",VIEWER_action_editdelete);
                    document.getElementById('VIEWER_menu').style.backgroundColor='#465298';
                    document.getElementById('VIEWER_actions').style.backgroundColor='#606dbc';
                    var actionbarHTML='';//['❮','🛈','✍','📥','▲','▼','❯']
                    actionbarHTML=actionbarHTML+"<div id='❮' class='VIEWER_actions_icon' onclick='VIEWER_action_viewprev();'>❮</div>";
                    actionbarHTML=actionbarHTML+"<div id='🛈' class='VIEWER_actions_icon' onclick='VIEWER_action_infos();'>🛈</div>";
                    actionbarHTML=actionbarHTML+"<div id='✍' class='VIEWER_actions_icon' onclick='VIEWER_action_edit();'>✍</div>";
                    actionbarHTML=actionbarHTML+"<div id='🗑️' class='VIEWER_actions_icon' onclick='VIEWER_action_editdelete();'>🗑️</div>";
                    actionbarHTML=actionbarHTML+"<div id='📥' class='VIEWER_actions_icon' onclick='VIEWER_action_download();'>📥</div>";
                    actionbarHTML=actionbarHTML+"<div id='▲' class='VIEWER_actions_icon' onclick='VIEWER_action_unread();' style='color:indianRed;'>▲</div>";
                    actionbarHTML=actionbarHTML+"<div id='▼' class='VIEWER_actions_icon' onclick='VIEWER_action_register();' style='color:black;'>▼</div>";
                    actionbarHTML=actionbarHTML+"<div id='❯' class='VIEWER_actions_icon' onclick='VIEWER_action_viewnext();'>❯</div>";
                    document.getElementById('VIEWER_actions').innerHTML=actionbarHTML;
                    apply_actionsMenu(false);
                }
                function VIEWER_loadArch(file){
                    VIEWER_list=DB_getArchList().filter(function(file){var stat=DB_FILE_getStat(file);return stat==' ';});//we filterout temp files
                    PAGE_key_set("Escape",function(){VIEWER_action_close();});
                    PAGE_key_set("i",function(){VIEWER_action_infos();});
                    PAGE_key_set("ArrowUp",function(){VIEWER_action_viewprev();});
                    PAGE_key_set("ArrowLeft",function(){VIEWER_action_viewprev();});
                    PAGE_key_set("ArrowDown",function(){VIEWER_action_viewnext();});
                    PAGE_key_set("ArrowRight",function(){VIEWER_action_viewnext();});
                    PAGE_key_set(" ",function(){VIEWER_action_streamTogglePlayPause();});
                    PAGE_key_set("CTRL_s",VIEWER_action_download);
                    PAGE_key_set("d",VIEWER_action_download);
                    document.getElementById('VIEWER_menu').style.backgroundColor='black';
                    document.getElementById('VIEWER_actions').style.backgroundColor='green';
                    var actionbarHTML='';//['❮','🛈','📥','⧋','❯']
                    actionbarHTML=actionbarHTML+"<div id='❮' class='VIEWER_actions_icon' onclick='VIEWER_action_viewprev();'>❮</div>";
                    actionbarHTML=actionbarHTML+"<div id='🛈' class='VIEWER_actions_icon' onclick='VIEWER_action_infos();'>🛈</div>";
                    actionbarHTML=actionbarHTML+"<div id='📥' class='VIEWER_actions_icon' onclick='VIEWER_action_download();'>📥</div>";
                    actionbarHTML=actionbarHTML+"<div id='⧋' class='VIEWER_actions_icon' onclick='VIEWER_action_copyback();'>⧋</div>";
                    actionbarHTML=actionbarHTML+"<div id='❯' class='VIEWER_actions_icon' onclick='VIEWER_action_viewnext();'>❯</div>";
                    document.getElementById('VIEWER_actions').innerHTML=actionbarHTML;
                    apply_actionsMenu(false);
                }
                document.getElementById('VIEWER').style.display='flex';
                VIEWER_FILE_load(file);
            }
            function VIEWER_unload(){
                PAGE_key_set("ArrowUp",true);
                PAGE_key_set("ArrowLeft",true);
                PAGE_key_set("ArrowDown",true);
                PAGE_key_set("ArrowRight",true);
                PAGE_key_set("Space",true);
                PAGE_key_set("e",true);
                PAGE_key_set("d",true);
                PAGE_key_set("CTRL_s",false);
                PAGE_key_set("i",true);
                PAGE_key_set("Delete",true);
                document.getElementById('VIEWER').style.display='none';
                VIEWER_FILE_unload();
                DB_focus();
            }
            function VIEWER_FILE_load(file){
                VIEWER_rank=VIEWER_list.findIndex(x => x.reference === file.reference);
                PAGE_change_title(DB_FILE_getCategory(file)+' '+DB_FILE_getName(file));
                document.getElementById('VIEWER_menu_main_filename').innerHTML=DB_FILE_getTextName(file);
                document.getElementById('VIEWER_menu_main_filedate').innerHTML='('+DB_FILE_getTextDate(file)+')';
                if(VIEWER_rank===0){document.getElementById('❮').style.visibility='hidden';}else{document.getElementById('❮').style.visibility='';}
                if(VIEWER_rank!==VIEWER_list.length-1){
                    document.getElementById('❯').style.visibility='';
                }
                else{
                    if(DB_FILE_getStat(file)==' '){
                        var more=DB_getArchList(true);
                        if(more!==null){
                            VIEWER_list=more.filter(function(file){var stat=DB_FILE_getStat(file);return stat==' ';});
                        }else{document.getElementById('❯').style.visibility='hidden';}
                    }else{document.getElementById('❯').style.visibility='hidden';}
                }
                //note: 3 conventions on elements:
                // id="VIEWER_streamer_visu" (potentially, for autoplay to work)
                // id="VIEWER_streamer" (potentially, for autoplay to work)
                // id="VIEWERer" (to stop img downloading)
                DB_FILE_printHTMLContent(file,document.getElementById('VIEWER_content'));
                apply_autoPlay();
                apply_volume();
            }
            function VIEWER_FILE_unload(){
                PAGE_change_title(DB_getName());
                if(document.getElementById('VIEWERer')){document.getElementById('VIEWERer').src = '';}
                var stream = document.getElementById("VIEWER_streamer");
                if(stream){//kill the video in android
                    stream.pause();
                    stream.removeAttribute('src');
                    stream.load();
                }//else no stream to extinguish
            }
            function apply_actionsMenu(toggle){
                // true swaps settings
                // false apply current settings

                // this function is called 2 times to set VIEWER_autoPlay
                // - once while loading a view menu
                // - can be called by JS if the toggle buton is hit


                if(toggle){VIEWER_actionsMenu=!VIEWER_actionsMenu;}
                if(VIEWER_actionsMenu){
                    var element=document.getElementById('VIEWER_menu_actions');
                    if(element){
                        element.style.backgroundColor=document.getElementById('VIEWER_actions').style.backgroundColor;
                    }
                    element=document.getElementById('VIEWER_actions');
                    if(element){
                        element.style.display='flex';
                    }
                }
                else{
                    var element=document.getElementById('VIEWER_menu_actions');
                    if(element){
                        element.style.backgroundColor='';
                    }
                    element=document.getElementById('VIEWER_actions');
                    if(element){
                        element.style.display='none';
                    }
                }
                return VIEWER_actionsMenu;
            }
            function apply_volume(volume){
                // * volume: number between 0 and 1 or undefined (call saved volume "VIEWER_volume")
                // this function is called 4 times
                // - once while loading a view audio streamfile ()
                // - once while loading a view video streamfile ()
                // - can be called by JS if a audio streamfile is shown .onvolumechange(volume)
                // - can be called by JS if a video streamfile is shown .onvolumechange(volume)
                if(volume==undefined){
                    var element=document.getElementById('VIEWER_streamer');
                    if(element){
                        if(typeof VIEWER_volume === 'string' || VIEWER_volume instanceof String){//muted
                            element.muted =true
                            element.volume =Number(VIEWER_volume);
                        }
                        else{
                            element.muted =false
                            element.volume =VIEWER_volume;
                        }
                    }
                }
                else{
                    var element=document.getElementById('VIEWER_streamer');
                    if(element){
                        if(element.muted){//muted
                            VIEWER_volume=volume.toString();
                        }
                        else{
                            VIEWER_volume=volume;
                        }
                    }
                }
            }
            function apply_autoPlay(toggle){
                // * true swaps settings
                // * false or nothing: apply current settings
                // this function is called 4 times to set VIEWER_autoPlay
                // - once while loading a view audio streamfile (false)
                // - once while loading a view video streamfile (false)
                // - can be called by JS if a audio streamfile is shown (true)
                // - can be called by JS if a video streamfile is shown (true)
                if(toggle){VIEWER_autoPlay=!VIEWER_autoPlay;}
                if(VIEWER_autoPlay){
                    var element=document.getElementById('VIEWER_streamer');
                    if(element){
                        var playPromise = element.play();
                        playPromise.then(_ => {}).catch(error => {});//catch errors if element is removed before promise is returned
                        element.onended =function(){VIEWER_action_viewnext();};
                        element=document.getElementById('VIEWER_streamer_visu');
                        if(element){
                            element.style.backgroundColor='indianRed';
                        }
                    }
                }
                else{
                    var element=document.getElementById('VIEWER_streamer');
                    if(element){
                        element.pause();
                        element.onended =function(){};
                        element=document.getElementById('VIEWER_streamer_visu');
                        if(element){
                            element.style.backgroundColor='DarkSlateGray';
                        }
                    }
                }
                return VIEWER_autoPlay;
            }
            function VIEWER_action_streamTogglePlayPause(){
                // If there is a player, toggle play / pause
                var element=document.getElementById('VIEWER_streamer');
                if(element){//if there is a player
                    if(element.currentTime > 0 && !element.paused && !element.ended && element.readyState > 2){//if player playing
                        element.pause();
                    }
                    else{
                        var playPromise = element.play();
                        playPromise.then(_ => {}).catch(error => {});//catch errors if element is removed before promise is returned
                    }
                }
            }
            function VIEWER_action_edit(){//✍
                PAGE_key_set("ArrowUp",true);
                PAGE_key_set("ArrowLeft",true);
                PAGE_key_set("ArrowDown",true);
                PAGE_key_set("ArrowRight",true);
                PAGE_key_set("Space",true);
                PAGE_key_set("e",true);
                PAGE_key_set("d",true);
                PAGE_key_set("CTRL_s",false);
                PAGE_key_set("i",true);
                PAGE_key_set("Delete",true);
                document.getElementById('VIEWER').style.display='none';
                VIEWER_FILE_unload();
                EDITOR_open(VIEWER_list[VIEWER_rank]);
            }
            function VIEWER_action_editdelete(){//️🗑️
                if(DB_editFileDelete(VIEWER_list[VIEWER_rank])){
                    if(document.getElementById('❯').style.visibility=='hidden'){
                        VIEWER_unload();
                    }
                    else{
                        VIEWER_load(VIEWER_list[VIEWER_rank+1]);
                    }
                }
            }
            function VIEWER_action_close(){//✕
                VIEWER_unload();
            }
            function VIEWER_action_viewprev(){//❮
                VIEWER_FILE_load(VIEWER_list[VIEWER_rank-1]);
            }
            function VIEWER_action_viewnext(){//❯
                VIEWER_FILE_load(VIEWER_list[VIEWER_rank+1]);
            }
            function VIEWER_action_register(){//▼
                if(DB_registerFile(VIEWER_list[VIEWER_rank])){
                    VIEWER_unload();
                }
            }
            function VIEWER_action_unread(){//▲
                if(DB_editFileUnread(VIEWER_list[VIEWER_rank])){
                    VIEWER_unload();
                }
            }
            function VIEWER_action_copyback(){//⧋
                DB_copybackFile(VIEWER_list[VIEWER_rank]);
                VIEWER_unload();
            }
            function VIEWER_action_infos(){//🛈
                var file=VIEWER_list[VIEWER_rank];
                var text_reference=DB_FILE_getReference(file);
                var text_date=DATE_getHumanDateFormat(DB_FILE_getDate(file));
                var text_name=DB_FILE_getTextName(file);
                var text_size=DB_FILE_getTextSize(file);
                var href=DB_FILE_getHref(file);
                var ext=DB_FILE_getExtension(file);
                var cat=DB_FILE_getCategory(file);
                console.log(file);
                alert('FILE REFERENCE: '+text_reference+'\n---------------\n- Date:  '+text_date+'\n- Name:  '+text_name+'\n- Size:  '+text_size);
            }
            function VIEWER_action_download(){//📥
                DB_FILE_download(VIEWER_list[VIEWER_rank]);
            }

            // EDITOR
            // ------
            function EDITOR_init(){
            }
            function EDITOR_open(file){
                EDITOR_load(file);
            }
            // EDITOR PRIVATE variables and functions
            var EDITOR_file=null;
            var EDITOR_submittedData=undefined;
            function EDITOR_load(file){
                // LOAD EDITOR **************
                PAGE_key_set("Escape",EDITOR_action_close);
                PAGE_key_set("CTRL_s",EDITOR_action_save);
                document.getElementById('EDITOR_menu_save').onclick=EDITOR_action_save;
                document.getElementById('EDITOR_menu_delete').onclick=EDITOR_action_delete;
                document.getElementById('EDITOR_menu_close').onclick=EDITOR_action_close;
                document.getElementById('EDITOR').zIndex='30';
                document.getElementById('EDITOR').style.display='flex';
                // LOAD FILE **************
                EDITOR_file=file;
                PAGE_change_title('✍ '+DB_FILE_getName(file));
                document.getElementById('EDITOR_menu_filename_textInput').value=DB_FILE_getName(file);
                document.getElementById('EDITOR_menu_filename_textInput').focus();
                document.getElementById('EDITOR_menu_filename_textInput').setSelectionRange(0,0);
                //fill EDITOR_content
                if(DB_FILE_getBin(file)===true){edit_generic(file,document.getElementById('EDITOR_content'));}
                else{edit_text(file,document.getElementById('EDITOR_content'));}
                function edit_text(file,element){
                    var unicID = (new Date()).getTime().toString();
                    element.innerHTML='<div id="wait'+unicID+'" style="width: 40px;height: 40px;margin: 100px auto;background-color: #333;border-radius: 100%;-webkit-animation: sk-scaleout 1.0s infinite ease-in-out;animation: sk-scaleout 1.0s infinite ease-in-out;}@-webkit-keyframes sk-scaleout {0% { -webkit-transform: scale(0) }100% { -webkit-transform: scale(1.0);opacity: 0;}}@keyframes sk-scaleout {0% { -webkit-transform: scale(0);transform: scale(0);} 100% {-webkit-transform: scale(1.0);transform: scale(1.0);opacity: 0;"></div>';
                    DB_FILE_downloadContent(
                        file,
                        function(textData){
                            if(document.getElementById("wait"+unicID)){
                                element.innerHTML='<textarea id="EDITOR_menu_filesize_textInput" style="border:0;background-color:white;text-align:left;margin:auto;padding:2em;max-width:70em;width:100%;height:100%;color:black;">'+textData+'</textarea>';
                                document.getElementById('EDITOR_menu_filesize_textInput').oninput=function(){EDITOR_submittedData={'method':'textData','textData': document.getElementById('EDITOR_menu_filesize_textInput').value};};
                            }//else: outdated request, the div was already overwitten
                        }
                    );
                }
                function edit_generic(file,element){
                    element.innerHTML=''+
                        '<div style="width:100%;height:100%;display:flex;align-items:center;">'+
                        '   <div id="EDITOR_content_editfilesize_dropTarget" style="margin:auto;text-align:center;color:white;border-radius:0.5em;background-color:red;padding:4em;text-decoration: none;cursor:pointer;" onclick="EDITOR_action_download();" alt="download" target="_blank">'+
                        '       <div style="font-size:5em;padding:0.5em;">'+DB_FILE_getCategory(file)+'</div>'+
                        '       Click to download<br>Drag and drop to upload (max: '+bytesToHumansize(DB_getMaxFileUploadSize())+').'+
                        '   </div>'+
                        '</div>';
                    document.getElementById('EDITOR_content_editfilesize_dropTarget').ondrop=function(e){
                        e.stopPropagation();
                        e.preventDefault();
                        if(e.dataTransfer.files.length===1){
                            async function uploadIfFile(file) {
                                try {
                                    await file.slice(0,1).arrayBuffer();// force an error if it is not a regular file
                                    if(file.size<DB_getMaxFileUploadSize()){
                                        document.getElementById('EDITOR_content_editfilesize_dropTarget').innerText='Upload: '+file.name;
                                        EDITOR_submittedData={'method':'fileData','fileData': submittedFile};
                                    }else{alert('File is too large to upload here (max: '+bytesToHumansize(SERVER_getMaxFileUploadSize())+')');}
                                }catch(err){alert('Cannot upload folders');}
                            }
                            uploadIfFile(e.dataTransfer.files[0]);
                        }else{alert('Cannot upload multiple files');}
                        return false;
                    }
                    document.getElementById('EDITOR_content_editfilesize_dropTarget').ondragover=function(e){
                        e.preventDefault();
                    }
                }
            }
            function EDITOR_unload(){
                //extremely important, risk of data loss
                EDITOR_submittedData=undefined;
                EDITOR_file=null;
                PAGE_key_set("Escape",true);
                PAGE_key_set("CTRL_s",false);
                PAGE_change_title(DB_getName());
                document.getElementById('EDITOR').style.display='none';
                DB_focus();
            }
            function EDITOR_action_close(){//✕
                EDITOR_unload();
            }
            function EDITOR_action_save(){//💾
                if(document.getElementById('EDITOR_menu_filename_textInput').value!==DB_FILE_getName(EDITOR_file) || EDITOR_submittedData!==undefined){
                    DB_editFile(EDITOR_file,undefined,undefined,document.getElementById('EDITOR_menu_filename_textInput').value,EDITOR_submittedData);
                }
                EDITOR_unload();
            }
            function EDITOR_action_delete(){//️🗑️
                DB_editFileDelete(EDITOR_file);
                EDITOR_unload();
            }

            // GENERIC FUNCTIONS AND VARIABLES
            // -------------------------------
            function txt2HTML(txt_data){
                return '<pre><code>'+txt_data.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")+'</code></pre>';
            }
            function eml2HTML(eml_data){
                function parseEml(eml_data){
                    var mimeData={
                        'header_from':"",
                        'header_to': "",
                        'header_date': "",
                        'header_subject': "",
                        'message_html': "",
                        'message_text': "",
                        'attachments': []
                    }
                    //lets prepare some specific variables
                    var parts = eml_data.split('\n\n');
                    var header = parts.splice(0,1)[0];
                    var body = parts.join('\n\n');
                    //lets process
                    mimeData.header_date= header.match(/^Date: *(.*)$/m);if(mimeData.header_date==null){mimeData.header_date="No Date";}else{mimeData.header_date=mimeData.header_date[1];}//not i: will be case-sensitive, not g: will find only the first one, m will search each line
                    mimeData.header_from= header.match(/^From: *(.*)$/m);if(mimeData.header_from==null){mimeData.header_from="No Sender";}else{mimeData.header_from=mimeData.header_from[1];}//not i: will be case-sensitive, not g: will find only the first one, m will search each line
                    mimeData.header_to  = header.match(/^To: *(.*)$/m);  if(mimeData.header_to==null){mimeData.header_to="No Recipient";}else{mimeData.header_to=mimeData.header_to[1];}//not i: will be case-sensitive, not g: will find only the first one, m will search each line
                    mimeData.header_subject= header.match(/^Subject: *(.*)$/m);if(mimeData.header_subject==null){mimeData.header_subject="No Subject";}else{mimeData.header_subject=mimeData.header_subject[1];}//not i: will be case-sensitive, not g: will find only the first one, m will search each line
                    var contentType=header.match(/^Content-Type: *(.*)/m);
                    if(contentType!==null){
                        contentType=contentType[1];
                        if(contentType.includes('multipart')){
                            var mimeTree=buildMimeTree(eml_data,true);
                            for(var mimeTreeIndex=0;mimeTreeIndex<mimeTree.length;mimeTreeIndex++){
                                switch(mimeTree[mimeTreeIndex].contentType){
                                    case 'text/plain':
                                        // mimeTree[mimeTreeIndex].contentType:'text/plain',
                                        // mimeTree[mimeTreeIndex].contentTransferEncoding:quoted-printable,base64. Unsupported: 8BIT, 7BIT, BINARY, x-token
                                        // mimeTree[mimeTreeIndex].charset:utf-8,UTF-8, iso-8859-1
                                        // size':filesize,
                                        // data':data
                                        if(mimeData.message_text==""){
                                            switch(mimeTree[mimeTreeIndex].contentTransferEncoding){
                                                case 'QUOTED-PRINTABLE':mimeData.message_text=quoted_printable_decode(mimeTree[mimeTreeIndex].data);break;
                                                case 'BASE64': mimeData.message_text=atob(mimeTree[mimeTreeIndex].data);break;
                                                case '8BIT':
                                                case '7BIT':mimeData.message_text=(mimeTree[mimeTreeIndex].data);break;
                                                case 'BINARY':
                                                case 'X-TOKEN':
                                                default:mimeData.message_text='(Message encoding is not supported: '+mimeTree[mimeTreeIndex].contentTransferEncoding+')';
                                            }
                                            switch(mimeTree[mimeTreeIndex].charset){
                                                case 'UTF-8': mimeData.message_text=utf8_decode(mimeData.message_text);break;
                                                case 'ISO-8859-1':break;
                                                default:;
                                            }
                                        }
                                        else{mimeData.attachments.push(mimeTree[mimeTreeIndex]);}
                                        break;
                                    case 'text/html':
                                        // I do not support html email
                                        //if(mimeData.message_html===""){mimeData.message_html=HTML2HTML(utf8_decode(quoted_printable_decode(mimeTree[mimeTreeIndex].data)));}
                                        //else{mimeData.attachments.push(mimeTree[mimeTreeIndex]);}
                                        break;
                                    default:mimeData.attachments.push(mimeTree[mimeTreeIndex]);
                                }
                            }
                        }
                        else if(contentType.includes('text/html')){
                            // I do not support html email
                            //mimeData.message_html=body;
                        }
                        else if(contentType.includes('text/plain')){
                            mimeData.message_text=utf8_decode(quoted_printable_decode(body));//this branch is rarely used
                        }
                        else{
                            console.log('WARNING: parseEml could not determine email message contentType');
                            mimeData=false;
                        }
                    }//else it is a message with no content (yes, can be just the subject with outlook)

                    function buildMimeTree(eml_data,flat){
                        //flat => it collects in a linear manner (simpler for our purpose)
                        //default => it will build a tree
                        if(flat===undefined){var flat=false;}
                        var i=0;
                        var mimeDataTree=[];
                        var contentType=eml_data.match(/^Content-Type[\t\f\v ]*:[\t\f\v ]*[\'\"]?([^\n\t\f\v ;\"\']*).*$/m)[1];
                        if(contentType!==null){
                            if(contentType.includes('multipart')){
                                var boundary=eml_data.match(/boundary[\t\f\v ]*=[\t\f\v ]*[\'\"]?([^\n\t\f\v ;\"\']*)[\'\"]?.*$/m);
                                if(boundary!==null){boundary=boundary[1];}else{console.log('Error: boundary not found for multipart mime');}
                                var parts = eml_data.split(boundary);
                                parts.splice(0,2);
                                parts.splice(-1,1);
                                for(var partIndex=0;partIndex<parts.length;partIndex++){
                                    var part=parts[partIndex];
                                    //clean up the leading and trailling broken lines
                                    var lines = part.split('\n');
                                    lines.splice(0,1);
                                    lines.splice(-1,1);
                                    part = lines.join('\n');
                                    if(flat){
                                        mimeDataTree=mimeDataTree.concat(buildMimeTree(part,flat));
                                    }
                                    else{
                                        mimeDataTree=mimeDataTree.push(buildMimeTree(part,flat));
                                    }
                                }
                            }
                            else{
                                //var contentType=(eml_data.match(/^Content-Type *: *(.*)/m)[1];
                                var contentTransferEncoding=eml_data.match(/^Content-Transfer-Encoding[\t\f\v ]*:[\t\f\v ]*[\'\"]?([^\n\t\f\v ;\'\"=]*)[\'\"]?.*$/m);
                                if(contentTransferEncoding!==null){contentTransferEncoding=contentTransferEncoding[1];}else{contentTransferEncoding='7BIT';}
                                var charset=eml_data.match(/charset[\t\f\v ]*=[\t\f\v ]*[\'\"]?([^\n\t\f\v ;\'\"=]*)[\'\"]?.*$/m);
                                if(charset!==null){charset=charset[1];}else{charset='UTF-8';}
                                var contentID=eml_data.match(/^Content-ID[\t\f\v ]*:[\t\f\v ]*[\'\"]?([^\n\t\f\v ;\'\"=]*)[\'\"]?.*$/m);
                                if(contentID!==null){contentID=contentID[1];}
                                var filename=eml_data.match(/filename[\t\f\v ]*=[\t\f\v ]*[\'\"]?([^\n;\'\"=]*)[\'\"]?.*$/m);
                                if(filename!==null){filename=filename[1];}
                                var filesize=eml_data.match(/size[\t\f\v ]*=[\t\f\v ]*[\'\"]?([^\n;\'\"=]*)[\'\"]?.*$/m);
                                if(filesize!==null){filesize=filesize[1];}
                                var data=eml_data.match(/[\n\r][\n\r][\n\r][\n\r]([\s\S]*)[\n\r]*$/);
                                if(data!==null){data=data[1];}
                                mimeDataTree.push({
                                    'contentType':contentType,
                                    'contentTransferEncoding':contentTransferEncoding.trim().toUpperCase(),
                                    'charset':charset.trim().toUpperCase(),
                                    'contentID': contentID,
                                    'filename':filename,
                                    'size':filesize,
                                    'data':data
                                });
                            }
                        }
                        else{
                            console.log('WARNING: that does not seem to be mime data');
                        }
                        return mimeDataTree;
                    }
                    /*
                    for(var partIndex=0;partIndex<parts.length;partIndex++){
                        // 1 collect html
                        if(parts[partIndex].includes("Content-Type: text/html;", 0) > 0){
                            emlData.message_html = parts[partIndex+1];
                            // must remove the =3D which is an incomplete escape code for "="
                            // which gets into Outlook MIME somehow - now sure
                            // also removing line breaks which are = at the very end
                            // followed by carriage return and new line
                            emlData.message_html = emlData.message_html.replace(/=3D/g,'=').replace(/=\r\n/g,"");
                        }
                        // 2 collect images data
                        if(parts[partIndex].includes("Content-Type: image/", 0) > 0){
                            var imgTag = parts[partIndex].split("\r\n");
                            var imgData = parts[partIndex+1];
                            var imgID = "";
                            for(var tagIndex=0;tagIndex<imgTag.length;tagIndex++){
                                if(imgTag[tagIndex].includes("Content-ID: ") > 0){
                                    imgID = "cid:" + imgTag[tagIndex].split(": ")[1].replace("<","").replace(">","");
                                }
                            }
                            images.push({'ID': imgData,'Data': imgID});
                        }
                    }*/
                    return mimeData;
                }
                function getMimeTypeIcon(MimeType){
                    return '?';
                }
                function quoted_printable_decode(str){
                    //       discuss at: http://phpjs.org/functions/quoted_printable_decode/
                    //      original by: Ole Vrijenhoek
                    //      bugfixed by: Brett Zamir (http://brett-zamir.me)
                    //      bugfixed by: Theriault
                    // reimplemented by: Theriault
                    //      improved by: Brett Zamir (http://brett-zamir.me)
                    //        example 1: quoted_printable_decode('a=3Db=3Dc');
                    //        returns 1: 'a=b=c'
                    //        example 2: quoted_printable_decode('abc  =20\r\n123  =20\r\n');
                    //        returns 2: 'abc   \r\n123   \r\n'
                    //        example 3: quoted_printable_decode('012345678901234567890123456789012345678901234567890123456789012345678901234=\r\n56789');
                    //        returns 3: '01234567890123456789012345678901234567890123456789012345678901234567890123456789'
                    //        example 4: quoted_printable_decode("Lorem ipsum dolor sit amet=23, consectetur adipisicing elit");
                    //        returns 4: 'Lorem ipsum dolor sit amet#, consectetur adipisicing elit'
                    var RFC2045Decode1 = /=\r\n/gm,
                    // Decodes all equal signs followed by two hex digits
                    RFC2045Decode2IN = /=([0-9A-F]{2})/gim,
                    // the RFC states against decoding lower case encodings, but following apparent PHP behavior // RFC2045Decode2IN = /=([0-9A-F]{2})/gm,
                    RFC2045Decode2OUT = function(sMatch, sHex){return String.fromCharCode(parseInt(sHex, 16));};
                    return str.replace(RFC2045Decode1, '').replace(RFC2045Decode2IN, RFC2045Decode2OUT);
                };
                function utf8_decode(str_data){
                    //  discuss at: http://phpjs.org/functions/utf8_decode/
                    // original by: Webtoolkit.info (http://www.webtoolkit.info/)
                    //    input by: Aman Gupta
                    //    input by: Brett Zamir (http://brett-zamir.me)
                    // improved by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
                    // improved by: Norman "zEh" Fuchs
                    // bugfixed by: hitwork
                    // bugfixed by: Onno Marsman
                    // bugfixed by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
                    // bugfixed by: kirilloid
                    //   example 1: utf8_decode('Kevin van Zonneveld');
                    //   returns 1: 'Kevin van Zonneveld'

                    var tmp_arr = [],
                        i = 0,
                        ac = 0,
                        c1 = 0,
                        c2 = 0,
                        c3 = 0,
                        c4 = 0;

                    str_data += '';

                    while (i < str_data.length){
                        c1 = str_data.charCodeAt(i);
                        if(c1 <= 191){
                            tmp_arr[ac++] = String.fromCharCode(c1);
                            i++;
                        } else if(c1 <= 223){
                            c2 = str_data.charCodeAt(i + 1);
                            tmp_arr[ac++] = String.fromCharCode(((c1 & 31) << 6) | (c2 & 63));
                            i += 2;
                        } else if(c1 <= 239){
                            // http://en.wikipedia.org/wiki/UTF-8#Codepage_layout
                            c2 = str_data.charCodeAt(i + 1);
                            c3 = str_data.charCodeAt(i + 2);
                            tmp_arr[ac++] = String.fromCharCode(((c1 & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));
                            i += 3;
                        } else {
                            c2 = str_data.charCodeAt(i + 1);
                            c3 = str_data.charCodeAt(i + 2);
                            c4 = str_data.charCodeAt(i + 3);
                            c1 = ((c1 & 7) << 18) | ((c2 & 63) << 12) | ((c3 & 63) << 6) | (c4 & 63);
                            c1 -= 0x10000;
                            tmp_arr[ac++] = String.fromCharCode(0xD800 | ((c1 >> 10) & 0x3FF));
                            tmp_arr[ac++] = String.fromCharCode(0xDC00 | (c1 & 0x3FF));
                            i += 4;
                        }
                    }

                    return tmp_arr.join('');
                }
                function rfc2047_decode(text){
                    const isUtf8RegExp = /^utf-?8$/i;
                    const isLatin1RegExp = /^(?:iso-8859-1|latin1)$/i;
                        function stringify(obj) {
                            if (typeof obj === 'string') {
                            return obj;
                            } else if (obj === null || typeof obj === 'undefined') {
                            return '';
                            } else {
                            return String(obj);
                            }
                        }
                        // Returns either a string (if successful) or undefined
                    function decodeEncodedWord(encodedText, encoding, charset) {
                        function decodeBuffer(encodedText, encoding) {

                    const replacementCharacterBuffer = Buffer.from('�');
                    if (encoding === 'q') {
                        encodedText = encodedText.replace(/_/g, ' ');
                        let numValidlyEncodedBytes = 0;
                        let i;
                        for (i = 0; i < encodedText.length; i += 1) {
                        if (
                            encodedText[i] === '=' &&
                            /^[0-9a-f]{2}$/i.test(encodedText.slice(i + 1, i + 3))
                        ) {
                            numValidlyEncodedBytes += 1;
                        }
                        }
                        const buffer = Buffer.alloc(
                        encodedText.length - numValidlyEncodedBytes * 2
                        );
                        let j = 0;
                        for (i = 0; i < encodedText.length; i += 1) {
                        if (encodedText[i] === '=') {
                            const hexChars = encodedText.slice(i + 1, i + 3);
                            if (/^[0-9a-f]{2}$/i.test(hexChars)) {
                            buffer[j] = parseInt(encodedText.substr(i + 1, 2), 16);
                            i += 2;
                            } else {
                            buffer[j] = encodedText.charCodeAt(i);
                            }
                        } else {
                            buffer[j] = encodedText.charCodeAt(i);
                        }
                        j += 1;
                        }
                        return buffer;
                    } else {
                        return Buffer.from(encodedText, 'base64');
                    }
                    }
                    if (encoding === 'q' && isLatin1RegExp.test(charset)) {
                        return unescape(
                        encodedText
                            .replace(/_/g, ' ')
                            .replace(/%/g, '%25')
                            .replace(/=(?=[0-9a-f]{2})/gi, '%')
                        );
                    } else {
                        let buffer;
                        try {
                        buffer = decodeBuffer(encodedText, encoding);
                        } catch (e) {
                        return;
                        }
                        if (/^ks_c_5601/i.test(charset)) {
                        charset = 'CP949';
                        }
                        var decoded;
                        if (iconv) {
                        let converter;
                        try {
                            converter = new iconv.Iconv(charset, 'utf-8//TRANSLIT');
                        } catch (e1) {
                            // Assume EINVAL (unsupported charset) and fall back to assuming iso-8859-1:
                            converter = new iconv.Iconv('iso-8859-1', 'utf-8//TRANSLIT');
                        }
                        try {
                            return converter.convert(buffer).toString('utf-8');
                        } catch (e2) {}
                        } else if (isUtf8RegExp.test(charset)) {
                        const decoded = buffer.toString('utf-8');
                        if (
                            !/\ufffd/.test(decoded) ||
                            buffer.includes(replacementCharacterBuffer)
                        ) {
                            return decoded;
                        }
                        } else if (/^(?:us-)?ascii$/i.test(charset)) {
                        return buffer.toString('ascii');
                        } /*else if (iconvLite.encodingExists(charset)) {
                        decoded = iconvLite.decode(buffer, charset);
                        if (
                            !/\ufffd/.test(decoded) ||
                            buffer.includes(replacementCharacterBuffer)
                        ) {
                            return decoded;
                        }
                        }*/
                    }
                    }
                    text = stringify(text).replace(/\?=\s+=\?/g, '?==?'); // Strip whitespace between neighbouring encoded words
                    let numEncodedWordsToIgnore = 0;
                    const encodedWordRegExp = /=\?([^?]+)\?([QB])\?([^?]*)\?=/gi;
                    return text.replace(
                        encodedWordRegExp,
                        (encodedWord, charset, encoding, encodedText, index) => {
                        if (numEncodedWordsToIgnore > 0) {
                            numEncodedWordsToIgnore -= 1;
                            return '';
                        }
                        encoding = encoding.toLowerCase();
                        let decodedTextOrBuffer = decodeEncodedWord(
                            encodedText,
                            encoding,
                            charset
                        );
                        while (typeof decodedTextOrBuffer !== 'string') {
                            // The encoded word couldn't be decoded because it contained a partial character in a multibyte charset.
                            // Keep trying to look ahead and consume an additional encoded word right after this one, and if its
                            // encoding and charsets match, try to decode the concatenation.

                            // The ongoing replace call is unaffected by this trick, so we don't need to reset .lastIndex afterwards:
                            encodedWordRegExp.lastIndex = index + encodedWord.length;
                            const matchNextEncodedWord = encodedWordRegExp.exec(text);
                            if (
                            matchNextEncodedWord &&
                            matchNextEncodedWord.index === index + encodedWord.length &&
                            matchNextEncodedWord[1] === charset &&
                            matchNextEncodedWord[2].toLowerCase() === encoding
                            ) {
                            numEncodedWordsToIgnore += 1;
                            encodedWord += matchNextEncodedWord[0];
                            encodedText += matchNextEncodedWord[3];
                            decodedTextOrBuffer = decodeEncodedWord(
                                encodedText,
                                encoding,
                                charset
                                );
                                } else {
                                return encodedWord;
                                }
                            }
                        return decodedTextOrBuffer;
                        }
                    );
                };
                var mimeData=parseEml(eml_data);
                if(mimeData!==false){
                    var message=mimeData.message_text;
                    //var message=mimeData.message_html;
                    //if(message===""){message=mimeData.message_text;}
                    var attachments=mimeData.attachments;
                    var attachmentsHTML="";
                    for(var attachmentsIndex=0;attachmentsIndex<attachments.length;attachmentsIndex++){
                        var attachment=mimeData.attachments[attachmentsIndex];
                        var attachmentContentType=attachment.contentType;
                        var attachmentcontentTransferEncoding=attachment.contentTransferEncoding;
                        var attachmentCharset=attachment.charset;
                        var attachmentContentId=attachment.contentID;
                        //var attachmentDataB64=attachment.data.replace(/(\r\n|\n|\r)/gm,"");
                        var attachmentDataB64=attachment.data.replaceAll("\r", "").replaceAll("\n", "");
                        var attachmentSize=attachment.size;
                        var attachmentFilename=attachment.filename;
                        var attachmentIcon=getMimeTypeIcon(attachmentContentType);
                        //attachmentsHTML=attachmentsHTML+"<div onclick='exportToFile(\""+attachmentDataB64+"\",\""+attachmentContentType+"\",\""+attachmentFilename+"\");' style='background-color:grey;display:inline-block;padding:0.5em;border:1px solid darkslategray;border-radius: 5px;'>"+attachmentIcon+"&nbsp;"+attachmentFilename+"</div><br>"
                        //attachmentsHTML=attachmentsHTML+"<a href='data:%22+attachmentContentType+%22;;base64,%22+attachmentDataB64+%22' style='background-color:grey;display:inline-block;padding:0.5em;border:1px solid darkslategray;border-radius: 5px;'>"+attachmentIcon+"&nbsp;"+attachmentFilename+"</a><br>"
                        switch(attachmentContentType){
                            case 'image/jpeg':
                            case 'image/gif':
                            case 'image/png':
                            case 'image/webp':
                            case 'image/bmp':
                                attachmentsHTML=attachmentsHTML+"<img onclick='downloadURI(\"data:"+attachmentContentType+";base64,"+attachmentDataB64+"\",\""+attachmentFilename+"\");' style='cursor:pointer;margin:1em;' src=\"data:"+attachmentContentType+";base64,"+attachmentDataB64+"\" alt=\"image\" height=600 widht=800 /><br>";
                                break;
                            default:
                                attachmentsHTML=attachmentsHTML+"<div  onclick='downloadURI(\"data:"+attachmentContentType+";base64,"+attachmentDataB64+"\",\""+attachmentFilename+"\");'style='cursor:pointer;background-color:grey;display:inline-block;padding:0.5em;border:1px solid darkslategray;border-radius: 5px;'>"+attachmentIcon+"&nbsp;"+attachmentFilename+"</div><br>";
                        }
                    }
                    return ''+
                    '<table style="border:none;">'+
                    '<tr><td>From: </td><td>'+str2HTML(mimeData.header_from)+'</td></tr>'+
                    '<tr><td>To: </td><td>'+str2HTML(mimeData.header_to)+'</td></tr>'+
                    '<tr><td>Date: </td><td>'+str2HTML(mimeData.header_date)+'</td></tr>'+
                    '</table>'+
                    '<h3>'+str2HTML(mimeData.header_subject)+'</h3>'+
                    '<hr>'+
                    str2HTML(message)+
                    '<hr>'+
                    attachmentsHTML;
                }else{return "Could not read email";}
            }
            function html2HTML(html_data){
                return code2HTML(html_data);
            }
            function code2HTML(code_data){
                // 1: Plain Text Search
                var html = code_data.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                html = "<pre><code>"+html+"</code></pre>";
                return html;
            }
            function vcf2HTML(vcf_data){
                //ligutweight Vcard parser / visualizer //Prints: PHOTO ()
                //Prints: FN (h1)
                //Prints: ORG, BDAY, TEL, ADR, EMAIL, URL, PHOTO, NOTEs
                //prints a link to the vcard
                var vcardvcf_dataing=vcf_data;
                var matchtoken=null;
                var i;
                var submatch=null;
                var HTML_photo="";
                var HTML_name="";
                var HTML_data="";

                //PHOTO
                matchtoken= vcardvcf_dataing.match(/(^PHOTO[\:;].*)$/mi);
                if(matchtoken!==null){
                    for(i=0;i<matchtoken.length;i++){
                        submatch= matchtoken[i].match(/^PHOTO.*(https?\:\/\/.*)$/i);
                        if(submatch===null){
                            submatch= matchtoken[i].match(/^PHOTO.*(data\:\/\/.*)$/i);
                            if(submatch===null){
                                submatch= matchtoken[i].match(/^PHOTO.*\:([^\:]*)$/i);
                                if(submatch==null){
                                        console.log("There is an image in this vcard, but I could not grab it");
                                }else{submatch[1]="data:"+submatch[1];}
                            }else{}//no formating required
                        }else{}//no formating required
                        HTML_photo=HTML_photo+"<img src=\""+submatch[1]+"\"/>";
                    }
                }

                //FN Name
                matchtoken= vcardvcf_dataing.match(/^FN\:(.+)$/mi);
                if(matchtoken!==null){
                    HTML_name="<h1>"+matchtoken[1]+"</h1>";
                }

                //org
                matchtoken= vcardvcf_dataing.match(/^ORG\:(.+)$/mi);
                if(matchtoken!==null){
                    matchtoken[1]=matchtoken[1].replace(';',' / ');
                    HTML_data=HTML_data+"<tr><td style=\"vertical-align:top;\">Organisation:</td><td>"+matchtoken[1]+"</td></tr>";
                }
                //email
                matchtoken= vcardvcf_dataing.match(/^EMAIL[\:;].*$/mgi);
                if(matchtoken!==null){
                    for(i=0;i<matchtoken.length;i++){
                        submatch= matchtoken[i].match(/^EMAIL[\:;]?(.*)\:([^\:]*)$/i);
                        HTML_data=HTML_data+"<tr><td style=\"vertical-align:top;\">Email ("+submatch[1]+"):</td><td>"+submatch[2]+"</td></tr>";
                    }
                }
                //tel
                matchtoken= vcardvcf_dataing.match(/^TEL[\:\;].*$/mgi);
                if(matchtoken!==null){
                    for(i=0;i<matchtoken.length;i++){
                        submatch= matchtoken[i].match(/^TEL[\:;]?(.*)\:([^\:]*)$/i);
                        HTML_data=HTML_data+"<tr><td style=\"vertical-align:top;\">Telephone ("+submatch[1]+"):</td><td>"+submatch[2]+"</td></tr>";
                    }
                }
                //adr
                matchtoken= vcardvcf_dataing.match(/^ADR[\:;].*$/mgi);
                if(matchtoken!==null){
                    for(i=0;i<matchtoken.length;i++){
                        submatch= matchtoken[i].match(/^ADR[\:;]?(.*)\:;*([^\:;].*)$/i);
                        submatch[2]=submatch[2].split(';').join("<br>");
                        HTML_data=HTML_data+"<tr><td style=\"vertical-align:top;\">Adress ("+submatch[1]+"):</td><td>"+submatch[2]+"</td></tr>";
                    }
                }
                //URL
                //email
                matchtoken= vcardvcf_dataing.match(/^URL[\:;].*$/mgi);
                if(matchtoken!==null){
                    for(i=0;i<matchtoken.length;i++){
                        submatch= matchtoken[i].match(/^URL[\:;]?(.*)\:([^\:]*)$/i);
                        HTML_data=HTML_data+"<tr><td style=\"vertical-align:top;\">URL ("+submatch[1]+"):</td><td>"+submatch[2]+"</td></tr>";
                    }
                }
                //bday
                matchtoken= vcardvcf_dataing.match(/^bday.*(\d\d\d\d)(\d\d)(\d\d)$/mi);
                if(matchtoken!==null){
                    var bday=matchtoken[1]+"-"+matchtoken[2]+"-"+matchtoken[3];
                    var today = new Date();
                    var birthDate = new Date(bday);
                    var age = today.getFullYear() - birthDate.getFullYear();
                    var m = today.getMonth() - birthDate.getMonth();
                    if(m < 0 || (m === 0 && today.getDate() < birthDate.getDate())){age--;}
                    HTML_data=HTML_data+"<tr><td>Birthday:</td><td>"+bday+" ("+age+"years)</td></tr>";
                }
                //notes
                matchtoken= vcardvcf_dataing.match(/^NOTE[\:;].*$/mgi);
                if(matchtoken!==null){
                    for(i=0;i<matchtoken.length;i++){
                        submatch= matchtoken[i].match(/^NOTE[\:;](.*)$/i);
                        submatch[1]=submatch[1].split('\n').join("<br>");
                        HTML_data=HTML_data+"<tr><td>Notes:</td><td>"+submatch[1]+"</td></tr>";
                    }
                }
                HTML_data="<table style:'width:50%;min-width=50em;border:0;vertical-align:top;'>"+HTML_data+"</table>";

                return "<div>"+HTML_photo+HTML_name+HTML_data+"</div>";
            }
            function md2HTML(md_data){
                /**
                 * marked - a markdown parser
                 * Copyright (c) 2011-2021, Christopher Jeffrey. (MIT Licensed)
                 * https://github.com/markedjs/marked
                 */
                !function(e,u){"object"==typeof exports&&"undefined"!=typeof module?module.exports=u():"function"==typeof define&&define.amd?define(u):(e="undefined"!=typeof globalThis?globalThis:e||self).marked=u()}(this,function(){"use strict";function r(e,u){for(var t=0;t<u.length;t++){var n=u[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function i(e,u){(null==u||u>e.length)&&(u=e.length);for(var t=0,n=new Array(u);t<u;t++)n[t]=e[t];return n}function c(e,u){var t;if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator])return(t=e[Symbol.iterator]()).next.bind(t);if(Array.isArray(e)||(t=function(e,u){if(e){if("string"==typeof e)return i(e,u);var t=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(t="Object"===t&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?i(e,u):void 0}}(e))||u&&e&&"number"==typeof e.length){t&&(e=t);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function t(e){return D[e]}var e,u=(function(u){function e(){return{baseUrl:null,breaks:!1,gfm:!0,headerIds:!0,headerPrefix:"",highlight:null,langPrefix:"language-",mangle:!0,pedantic:!1,renderer:null,sanitize:!1,sanitizer:null,silent:!1,smartLists:!1,smartypants:!1,tokenizer:null,walkTokens:null,xhtml:!1}}u.exports={defaults:e(),getDefaults:e,changeDefaults:function(e){u.exports.defaults=e}}}(e={exports:{}}),e.exports),n=/[&<>"']/,s=/[&<>"']/g,l=/[<>"']|&(?!#?\w+;)/,a=/[<>"']|&(?!#?\w+;)/g,D={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};var o=/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/gi;function h(e){return e.replace(o,function(e,u){return"colon"===(u=u.toLowerCase())?":":"#"===u.charAt(0)?"x"===u.charAt(1)?String.fromCharCode(parseInt(u.substring(2),16)):String.fromCharCode(+u.substring(1)):""})}var p=/(^|[^\[])\^/g;var g=/[^\w:]/g,f=/^$|^[a-z][a-z0-9+.-]*:|^[?#]/i;var F={},A=/^[^:]+:\/*[^/]*$/,C=/^([^:]+:)[\s\S]*$/,d=/^([^:]+:\/*[^/]*)[\s\S]*$/;function E(e,u){F[" "+e]||(A.test(e)?F[" "+e]=e+"/":F[" "+e]=k(e,"/",!0));var t=-1===(e=F[" "+e]).indexOf(":");return"//"===u.substring(0,2)?t?u:e.replace(C,"$1")+u:"/"===u.charAt(0)?t?u:e.replace(d,"$1")+u:e+u}function k(e,u,t){var n=e.length;if(0===n)return"";for(var r=0;r<n;){var i=e.charAt(n-r-1);if(i!==u||t){if(i===u||!t)break;r++}else r++}return e.substr(0,n-r)}var m=function(e,u){if(u){if(n.test(e))return e.replace(s,t)}else if(l.test(e))return e.replace(a,t);return e},b=h,x=function(t,e){t=t.source||t,e=e||"";var n={replace:function(e,u){return u=(u=u.source||u).replace(p,"$1"),t=t.replace(e,u),n},getRegex:function(){return new RegExp(t,e)}};return n},B=function(e,u,t){if(e){var n;try{n=decodeURIComponent(h(t)).replace(g,"").toLowerCase()}catch(e){return null}if(0===n.indexOf("javascript:")||0===n.indexOf("vbscript:")||0===n.indexOf("data:"))return null}u&&!f.test(t)&&(t=E(u,t));try{t=encodeURI(t).replace(/%25/g,"%")}catch(e){return null}return t},w={exec:function(){}},v=function(e){for(var u,t,n=1;n<arguments.length;n++)for(t in u=arguments[n])Object.prototype.hasOwnProperty.call(u,t)&&(e[t]=u[t]);return e},y=function(e){e&&e.sanitize&&!e.silent&&console.warn("marked(): sanitize and sanitizer parameters are deprecated since version 0.7.0, should not be used and will be removed in the future. Read more here: https://marked.js.org/#/USING_ADVANCED.md#options")},_=function(e,u){if(u<1)return"";for(var t="";1<u;)1&u&&(t+=e),u>>=1,e+=e;return t+e},z=u.defaults,$=k,S=function(e,u){var t=e.replace(/\|/g,function(e,u,t){for(var n=!1,r=u;0<=--r&&"\\"===t[r];)n=!n;return n?"|":" |"}).split(/ \|/),n=0;if(t.length>u)t.splice(u);else for(;t.length<u;)t.push("");for(;n<t.length;n++)t[n]=t[n].trim().replace(/\\\|/g,"|");return t},T=m,I=function(e,u){if(-1===e.indexOf(u[1]))return-1;for(var t=e.length,n=0,r=0;r<t;r++)if("\\"===e[r])r++;else if(e[r]===u[0])n++;else if(e[r]===u[1]&&--n<0)return r;return-1};function R(e,u,t){var n=u.href,r=u.title?T(u.title):null,u=e[1].replace(/\\([\[\]])/g,"$1");return"!"!==e[0].charAt(0)?{type:"link",raw:t,href:n,title:r,text:u}:{type:"image",raw:t,href:n,title:r,text:T(u)}}var Z=function(){function e(e){this.options=e||z}var u=e.prototype;return u.space=function(e){e=this.rules.block.newline.exec(e);if(e)return 1<e[0].length?{type:"space",raw:e[0]}:{raw:"\n"}},u.code=function(e){var u=this.rules.block.code.exec(e);if(u){e=u[0].replace(/^ {1,4}/gm,"");return{type:"code",raw:u[0],codeBlockStyle:"indented",text:this.options.pedantic?e:$(e,"\n")}}},u.fences=function(e){var u=this.rules.block.fences.exec(e);if(u){var t=u[0],e=function(e,u){if(null===(e=e.match(/^(\s+)(?:```)/)))return u;var t=e[1];return u.split("\n").map(function(e){var u=e.match(/^\s+/);return null!==u&&u[0].length>=t.length?e.slice(t.length):e}).join("\n")}(t,u[3]||"");return{type:"code",raw:t,lang:u[2]&&u[2].trim(),text:e}}},u.heading=function(e){var u=this.rules.block.heading.exec(e);if(u){var t=u[2].trim();return/#$/.test(t)&&(e=$(t,"#"),!this.options.pedantic&&e&&!/ $/.test(e)||(t=e.trim())),{type:"heading",raw:u[0],depth:u[1].length,text:t}}},u.nptable=function(e){e=this.rules.block.nptable.exec(e);if(e){var u={type:"table",header:S(e[1].replace(/^ *| *\| *$/g,"")),align:e[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:e[3]?e[3].replace(/\n$/,"").split("\n"):[],raw:e[0]};if(u.header.length===u.align.length){for(var t=u.align.length,n=0;n<t;n++)/^ *-+: *$/.test(u.align[n])?u.align[n]="right":/^ *:-+: *$/.test(u.align[n])?u.align[n]="center":/^ *:-+ *$/.test(u.align[n])?u.align[n]="left":u.align[n]=null;for(t=u.cells.length,n=0;n<t;n++)u.cells[n]=S(u.cells[n],u.header.length);return u}}},u.hr=function(e){e=this.rules.block.hr.exec(e);if(e)return{type:"hr",raw:e[0]}},u.blockquote=function(e){var u=this.rules.block.blockquote.exec(e);if(u){e=u[0].replace(/^ *> ?/gm,"");return{type:"blockquote",raw:u[0],text:e}}},u.list=function(e){e=this.rules.block.list.exec(e);if(e){for(var u,t,n,r,i,s,l=e[0],a=e[2],D=1<a.length,o={type:"list",raw:l,ordered:D,start:D?+a.slice(0,-1):"",loose:!1,items:[]},c=e[0].match(this.rules.block.item),h=!1,p=c.length,g=this.rules.block.listItemStart.exec(c[0]),f=0;f<p;f++){if(l=u=c[f],this.options.pedantic||(s=u.match(new RegExp("\\n\\s*\\n {0,"+(g[0].length-1)+"}\\S")))&&(t=u.length-s.index+c.slice(f+1).join("\n").length,o.raw=o.raw.substring(0,o.raw.length-t),l=u=u.substring(0,s.index),p=f+1),f!==p-1){if(n=this.rules.block.listItemStart.exec(c[f+1]),this.options.pedantic?n[1].length>g[1].length:n[1].length>=g[0].length||3<n[1].length){c.splice(f,2,c[f]+(!this.options.pedantic&&n[1].length<g[0].length&&!c[f].match(/\n$/)?"":"\n")+c[f+1]),f--,p--;continue}(!this.options.pedantic||this.options.smartLists?n[2][n[2].length-1]!==a[a.length-1]:D==(1===n[2].length))&&(t=c.slice(f+1).join("\n").length,o.raw=o.raw.substring(0,o.raw.length-t),f=p-1),g=n}n=u.length,~(u=u.replace(/^ *([*+-]|\d+[.)]) ?/,"")).indexOf("\n ")&&(n-=u.length,u=this.options.pedantic?u.replace(/^ {1,4}/gm,""):u.replace(new RegExp("^ {1,"+n+"}","gm"),"")),u=$(u,"\n"),f!==p-1&&(l+="\n"),n=h||/\n\n(?!\s*$)/.test(l),f!==p-1&&(h="\n\n"===l.slice(-2),n=n||h),n&&(o.loose=!0),this.options.gfm&&(i=void 0,(r=/^\[[ xX]\] /.test(u))&&(i=" "!==u[1],u=u.replace(/^\[[ xX]\] +/,""))),o.items.push({type:"list_item",raw:l,task:r,checked:i,loose:n,text:u})}return o}},u.html=function(e){e=this.rules.block.html.exec(e);if(e)return{type:this.options.sanitize?"paragraph":"html",raw:e[0],pre:!this.options.sanitizer&&("pre"===e[1]||"script"===e[1]||"style"===e[1]),text:this.options.sanitize?this.options.sanitizer?this.options.sanitizer(e[0]):T(e[0]):e[0]}},u.def=function(e){e=this.rules.block.def.exec(e);if(e)return e[3]&&(e[3]=e[3].substring(1,e[3].length-1)),{type:"def",tag:e[1].toLowerCase().replace(/\s+/g," "),raw:e[0],href:e[2],title:e[3]}},u.table=function(e){e=this.rules.block.table.exec(e);if(e){var u={type:"table",header:S(e[1].replace(/^ *| *\| *$/g,"")),align:e[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:e[3]?e[3].replace(/\n$/,"").split("\n"):[]};if(u.header.length===u.align.length){u.raw=e[0];for(var t=u.align.length,n=0;n<t;n++)/^ *-+: *$/.test(u.align[n])?u.align[n]="right":/^ *:-+: *$/.test(u.align[n])?u.align[n]="center":/^ *:-+ *$/.test(u.align[n])?u.align[n]="left":u.align[n]=null;for(t=u.cells.length,n=0;n<t;n++)u.cells[n]=S(u.cells[n].replace(/^ *\| *| *\| *$/g,""),u.header.length);return u}}},u.lheading=function(e){e=this.rules.block.lheading.exec(e);if(e)return{type:"heading",raw:e[0],depth:"="===e[2].charAt(0)?1:2,text:e[1]}},u.paragraph=function(e){e=this.rules.block.paragraph.exec(e);if(e)return{type:"paragraph",raw:e[0],text:"\n"===e[1].charAt(e[1].length-1)?e[1].slice(0,-1):e[1]}},u.text=function(e){e=this.rules.block.text.exec(e);if(e)return{type:"text",raw:e[0],text:e[0]}},u.escape=function(e){e=this.rules.inline.escape.exec(e);if(e)return{type:"escape",raw:e[0],text:T(e[1])}},u.tag=function(e,u,t){e=this.rules.inline.tag.exec(e);if(e)return!u&&/^<a /i.test(e[0])?u=!0:u&&/^<\/a>/i.test(e[0])&&(u=!1),!t&&/^<(pre|code|kbd|script)(\s|>)/i.test(e[0])?t=!0:t&&/^<\/(pre|code|kbd|script)(\s|>)/i.test(e[0])&&(t=!1),{type:this.options.sanitize?"text":"html",raw:e[0],inLink:u,inRawBlock:t,text:this.options.sanitize?this.options.sanitizer?this.options.sanitizer(e[0]):T(e[0]):e[0]}},u.link=function(e){var u=this.rules.inline.link.exec(e);if(u){var t=u[2].trim();if(!this.options.pedantic&&/^</.test(t)){if(!/>$/.test(t))return;e=$(t.slice(0,-1),"\\");if((t.length-e.length)%2==0)return}else{var n=I(u[2],"()");-1<n&&(i=(0===u[0].indexOf("!")?5:4)+u[1].length+n,u[2]=u[2].substring(0,n),u[0]=u[0].substring(0,i).trim(),u[3]="")}var r,n=u[2],i="";return this.options.pedantic?(r=/^([^'"]*[^\s])\s+(['"])(.*)\2/.exec(n))&&(n=r[1],i=r[3]):i=u[3]?u[3].slice(1,-1):"",n=n.trim(),R(u,{href:(n=/^</.test(n)?this.options.pedantic&&!/>$/.test(t)?n.slice(1):n.slice(1,-1):n)&&n.replace(this.rules.inline._escapes,"$1"),title:i&&i.replace(this.rules.inline._escapes,"$1")},u[0])}},u.reflink=function(e,u){if((t=this.rules.inline.reflink.exec(e))||(t=this.rules.inline.nolink.exec(e))){e=(t[2]||t[1]).replace(/\s+/g," ");if((e=u[e.toLowerCase()])&&e.href)return R(t,e,t[0]);var t=t[0].charAt(0);return{type:"text",raw:t,text:t}}},u.emStrong=function(e,u,t){void 0===t&&(t="");var n=this.rules.inline.emStrong.lDelim.exec(e);if(n&&(!n[3]||!t.match(/(?:[0-9A-Za-z\xAA\xB2\xB3\xB5\xB9\xBA\xBC-\xBE\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u052F\u0531-\u0556\u0559\u0560-\u0588\u05D0-\u05EA\u05EF-\u05F2\u0620-\u064A\u0660-\u0669\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07C0-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u0860-\u086A\u08A0-\u08B4\u08B6-\u08C7\u0904-\u0939\u093D\u0950\u0958-\u0961\u0966-\u096F\u0971-\u0980\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09E6-\u09F1\u09F4-\u09F9\u09FC\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A66-\u0A6F\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0AE6-\u0AEF\u0AF9\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B66-\u0B6F\u0B71-\u0B77\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0BE6-\u0BF2\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D\u0C58-\u0C5A\u0C60\u0C61\u0C66-\u0C6F\u0C78-\u0C7E\u0C80\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0\u0CE1\u0CE6-\u0CEF\u0CF1\u0CF2\u0D04-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D54-\u0D56\u0D58-\u0D61\u0D66-\u0D78\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0DE6-\u0DEF\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E50-\u0E59\u0E81\u0E82\u0E84\u0E86-\u0E8A\u0E8C-\u0EA3\u0EA5\u0EA7-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0ED0-\u0ED9\u0EDC-\u0EDF\u0F00\u0F20-\u0F33\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F-\u1049\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u1090-\u1099\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1369-\u137C\u1380-\u138F\u13A0-\u13F5\u13F8-\u13FD\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u17E0-\u17E9\u17F0-\u17F9\u1810-\u1819\u1820-\u1878\u1880-\u1884\u1887-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191E\u1946-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u19D0-\u19DA\u1A00-\u1A16\u1A20-\u1A54\u1A80-\u1A89\u1A90-\u1A99\u1AA7\u1B05-\u1B33\u1B45-\u1B4B\u1B50-\u1B59\u1B83-\u1BA0\u1BAE-\u1BE5\u1C00-\u1C23\u1C40-\u1C49\u1C4D-\u1C7D\u1C80-\u1C88\u1C90-\u1CBA\u1CBD-\u1CBF\u1CE9-\u1CEC\u1CEE-\u1CF3\u1CF5\u1CF6\u1CFA\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2070\u2071\u2074-\u2079\u207F-\u2089\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2150-\u2189\u2460-\u249B\u24EA-\u24FF\u2776-\u2793\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2CFD\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2E2F\u3005-\u3007\u3021-\u3029\u3031-\u3035\u3038-\u303C\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312F\u3131-\u318E\u3192-\u3195\u31A0-\u31BF\u31F0-\u31FF\u3220-\u3229\u3248-\u324F\u3251-\u325F\u3280-\u3289\u32B1-\u32BF\u3400-\u4DBF\u4E00-\u9FFC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA62B\uA640-\uA66E\uA67F-\uA69D\uA6A0-\uA6EF\uA717-\uA71F\uA722-\uA788\uA78B-\uA7BF\uA7C2-\uA7CA\uA7F5-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA830-\uA835\uA840-\uA873\uA882-\uA8B3\uA8D0-\uA8D9\uA8F2-\uA8F7\uA8FB\uA8FD\uA8FE\uA900-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF-\uA9D9\uA9E0-\uA9E4\uA9E6-\uA9FE\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA50-\uAA59\uAA60-\uAA76\uAA7A\uAA7E-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB69\uAB70-\uABE2\uABF0-\uABF9\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF10-\uFF19\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]|\uD800[\uDC00-\uDC0B\uDC0D-\uDC26\uDC28-\uDC3A\uDC3C\uDC3D\uDC3F-\uDC4D\uDC50-\uDC5D\uDC80-\uDCFA\uDD07-\uDD33\uDD40-\uDD78\uDD8A\uDD8B\uDE80-\uDE9C\uDEA0-\uDED0\uDEE1-\uDEFB\uDF00-\uDF23\uDF2D-\uDF4A\uDF50-\uDF75\uDF80-\uDF9D\uDFA0-\uDFC3\uDFC8-\uDFCF\uDFD1-\uDFD5]|\uD801[\uDC00-\uDC9D\uDCA0-\uDCA9\uDCB0-\uDCD3\uDCD8-\uDCFB\uDD00-\uDD27\uDD30-\uDD63\uDE00-\uDF36\uDF40-\uDF55\uDF60-\uDF67]|\uD802[\uDC00-\uDC05\uDC08\uDC0A-\uDC35\uDC37\uDC38\uDC3C\uDC3F-\uDC55\uDC58-\uDC76\uDC79-\uDC9E\uDCA7-\uDCAF\uDCE0-\uDCF2\uDCF4\uDCF5\uDCFB-\uDD1B\uDD20-\uDD39\uDD80-\uDDB7\uDDBC-\uDDCF\uDDD2-\uDE00\uDE10-\uDE13\uDE15-\uDE17\uDE19-\uDE35\uDE40-\uDE48\uDE60-\uDE7E\uDE80-\uDE9F\uDEC0-\uDEC7\uDEC9-\uDEE4\uDEEB-\uDEEF\uDF00-\uDF35\uDF40-\uDF55\uDF58-\uDF72\uDF78-\uDF91\uDFA9-\uDFAF]|\uD803[\uDC00-\uDC48\uDC80-\uDCB2\uDCC0-\uDCF2\uDCFA-\uDD23\uDD30-\uDD39\uDE60-\uDE7E\uDE80-\uDEA9\uDEB0\uDEB1\uDF00-\uDF27\uDF30-\uDF45\uDF51-\uDF54\uDFB0-\uDFCB\uDFE0-\uDFF6]|\uD804[\uDC03-\uDC37\uDC52-\uDC6F\uDC83-\uDCAF\uDCD0-\uDCE8\uDCF0-\uDCF9\uDD03-\uDD26\uDD36-\uDD3F\uDD44\uDD47\uDD50-\uDD72\uDD76\uDD83-\uDDB2\uDDC1-\uDDC4\uDDD0-\uDDDA\uDDDC\uDDE1-\uDDF4\uDE00-\uDE11\uDE13-\uDE2B\uDE80-\uDE86\uDE88\uDE8A-\uDE8D\uDE8F-\uDE9D\uDE9F-\uDEA8\uDEB0-\uDEDE\uDEF0-\uDEF9\uDF05-\uDF0C\uDF0F\uDF10\uDF13-\uDF28\uDF2A-\uDF30\uDF32\uDF33\uDF35-\uDF39\uDF3D\uDF50\uDF5D-\uDF61]|\uD805[\uDC00-\uDC34\uDC47-\uDC4A\uDC50-\uDC59\uDC5F-\uDC61\uDC80-\uDCAF\uDCC4\uDCC5\uDCC7\uDCD0-\uDCD9\uDD80-\uDDAE\uDDD8-\uDDDB\uDE00-\uDE2F\uDE44\uDE50-\uDE59\uDE80-\uDEAA\uDEB8\uDEC0-\uDEC9\uDF00-\uDF1A\uDF30-\uDF3B]|\uD806[\uDC00-\uDC2B\uDCA0-\uDCF2\uDCFF-\uDD06\uDD09\uDD0C-\uDD13\uDD15\uDD16\uDD18-\uDD2F\uDD3F\uDD41\uDD50-\uDD59\uDDA0-\uDDA7\uDDAA-\uDDD0\uDDE1\uDDE3\uDE00\uDE0B-\uDE32\uDE3A\uDE50\uDE5C-\uDE89\uDE9D\uDEC0-\uDEF8]|\uD807[\uDC00-\uDC08\uDC0A-\uDC2E\uDC40\uDC50-\uDC6C\uDC72-\uDC8F\uDD00-\uDD06\uDD08\uDD09\uDD0B-\uDD30\uDD46\uDD50-\uDD59\uDD60-\uDD65\uDD67\uDD68\uDD6A-\uDD89\uDD98\uDDA0-\uDDA9\uDEE0-\uDEF2\uDFB0\uDFC0-\uDFD4]|\uD808[\uDC00-\uDF99]|\uD809[\uDC00-\uDC6E\uDC80-\uDD43]|[\uD80C\uD81C-\uD820\uD822\uD840-\uD868\uD86A-\uD86C\uD86F-\uD872\uD874-\uD879\uD880-\uD883][\uDC00-\uDFFF]|\uD80D[\uDC00-\uDC2E]|\uD811[\uDC00-\uDE46]|\uD81A[\uDC00-\uDE38\uDE40-\uDE5E\uDE60-\uDE69\uDED0-\uDEED\uDF00-\uDF2F\uDF40-\uDF43\uDF50-\uDF59\uDF5B-\uDF61\uDF63-\uDF77\uDF7D-\uDF8F]|\uD81B[\uDE40-\uDE96\uDF00-\uDF4A\uDF50\uDF93-\uDF9F\uDFE0\uDFE1\uDFE3]|\uD821[\uDC00-\uDFF7]|\uD823[\uDC00-\uDCD5\uDD00-\uDD08]|\uD82C[\uDC00-\uDD1E\uDD50-\uDD52\uDD64-\uDD67\uDD70-\uDEFB]|\uD82F[\uDC00-\uDC6A\uDC70-\uDC7C\uDC80-\uDC88\uDC90-\uDC99]|\uD834[\uDEE0-\uDEF3\uDF60-\uDF78]|\uD835[\uDC00-\uDC54\uDC56-\uDC9C\uDC9E\uDC9F\uDCA2\uDCA5\uDCA6\uDCA9-\uDCAC\uDCAE-\uDCB9\uDCBB\uDCBD-\uDCC3\uDCC5-\uDD05\uDD07-\uDD0A\uDD0D-\uDD14\uDD16-\uDD1C\uDD1E-\uDD39\uDD3B-\uDD3E\uDD40-\uDD44\uDD46\uDD4A-\uDD50\uDD52-\uDEA5\uDEA8-\uDEC0\uDEC2-\uDEDA\uDEDC-\uDEFA\uDEFC-\uDF14\uDF16-\uDF34\uDF36-\uDF4E\uDF50-\uDF6E\uDF70-\uDF88\uDF8A-\uDFA8\uDFAA-\uDFC2\uDFC4-\uDFCB\uDFCE-\uDFFF]|\uD838[\uDD00-\uDD2C\uDD37-\uDD3D\uDD40-\uDD49\uDD4E\uDEC0-\uDEEB\uDEF0-\uDEF9]|\uD83A[\uDC00-\uDCC4\uDCC7-\uDCCF\uDD00-\uDD43\uDD4B\uDD50-\uDD59]|\uD83B[\uDC71-\uDCAB\uDCAD-\uDCAF\uDCB1-\uDCB4\uDD01-\uDD2D\uDD2F-\uDD3D\uDE00-\uDE03\uDE05-\uDE1F\uDE21\uDE22\uDE24\uDE27\uDE29-\uDE32\uDE34-\uDE37\uDE39\uDE3B\uDE42\uDE47\uDE49\uDE4B\uDE4D-\uDE4F\uDE51\uDE52\uDE54\uDE57\uDE59\uDE5B\uDE5D\uDE5F\uDE61\uDE62\uDE64\uDE67-\uDE6A\uDE6C-\uDE72\uDE74-\uDE77\uDE79-\uDE7C\uDE7E\uDE80-\uDE89\uDE8B-\uDE9B\uDEA1-\uDEA3\uDEA5-\uDEA9\uDEAB-\uDEBB]|\uD83C[\uDD00-\uDD0C]|\uD83E[\uDFF0-\uDFF9]|\uD869[\uDC00-\uDEDD\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF34\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEA1\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A])/))){var r=n[1]||n[2]||"";if(!r||r&&(""===t||this.rules.inline.punctuation.exec(t))){var i,s=n[0].length-1,l=s,a=0,D="*"===n[0][0]?this.rules.inline.emStrong.rDelimAst:this.rules.inline.emStrong.rDelimUnd;for(D.lastIndex=0,u=u.slice(-1*e.length+s);null!=(n=D.exec(u));)if(i=n[1]||n[2]||n[3]||n[4]||n[5]||n[6])if(i=i.length,n[3]||n[4])l+=i;else if(!((n[5]||n[6])&&s%3)||(s+i)%3){if(!(0<(l-=i))){if(l+a-i<=0&&!u.slice(D.lastIndex).match(D)&&(i=Math.min(i,i+l+a)),Math.min(s,i)%2)return{type:"em",raw:e.slice(0,s+n.index+i+1),text:e.slice(1,s+n.index+i)};if(Math.min(s,i)%2==0)return{type:"strong",raw:e.slice(0,s+n.index+i+1),text:e.slice(2,s+n.index+i-1)}}}else a+=i}}},u.codespan=function(e){var u=this.rules.inline.code.exec(e);if(u){var t=u[2].replace(/\n/g," "),n=/[^ ]/.test(t),e=/^ /.test(t)&&/ $/.test(t);return n&&e&&(t=t.substring(1,t.length-1)),t=T(t,!0),{type:"codespan",raw:u[0],text:t}}},u.br=function(e){e=this.rules.inline.br.exec(e);if(e)return{type:"br",raw:e[0]}},u.del=function(e){e=this.rules.inline.del.exec(e);if(e)return{type:"del",raw:e[0],text:e[2]}},u.autolink=function(e,u){e=this.rules.inline.autolink.exec(e);if(e){var t,u="@"===e[2]?"mailto:"+(t=T(this.options.mangle?u(e[1]):e[1])):t=T(e[1]);return{type:"link",raw:e[0],text:t,href:u,tokens:[{type:"text",raw:t,text:t}]}}},u.url=function(e,u){var t,n,r,i;if(t=this.rules.inline.url.exec(e)){if("@"===t[2])r="mailto:"+(n=T(this.options.mangle?u(t[0]):t[0]));else{for(;i=t[0],t[0]=this.rules.inline._backpedal.exec(t[0])[0],i!==t[0];);n=T(t[0]),r="www."===t[1]?"http://"+n:n}return{type:"link",raw:t[0],text:n,href:r,tokens:[{type:"text",raw:n,text:n}]}}},u.inlineText=function(e,u,t){e=this.rules.inline.text.exec(e);if(e){t=u?this.options.sanitize?this.options.sanitizer?this.options.sanitizer(e[0]):T(e[0]):e[0]:T(this.options.smartypants?t(e[0]):e[0]);return{type:"text",raw:e[0],text:t}}},e}(),q=w,O=x,w=v,x={newline:/^(?: *(?:\n|$))+/,code:/^( {4}[^\n]+(?:\n(?: *(?:\n|$))*)?)+/,fences:/^ {0,3}(`{3,}(?=[^`\n]*\n)|~{3,})([^\n]*)\n(?:|([\s\S]*?)\n)(?: {0,3}\1[~`]* *(?:\n+|$)|$)/,hr:/^ {0,3}((?:- *){3,}|(?:_ *){3,}|(?:\* *){3,})(?:\n+|$)/,heading:/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,blockquote:/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/,list:/^( {0,3})(bull) [\s\S]+?(?:hr|def|\n{2,}(?! )(?! {0,3}bull )\n*|\s*$)/,html:"^ {0,3}(?:<(script|pre|style)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:\\n{2,}|$)|<(?!script|pre|style)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:\\n{2,}|$)|</(?!script|pre|style)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:\\n{2,}|$))",def:/^ {0,3}\[(label)\]: *\n? *<?([^\s>]+)>?(?:(?: +\n? *| *\n *)(title))? *(?:\n+|$)/,nptable:q,table:q,lheading:/^([^\n]+)\n {0,3}(=+|-+) *(?:\n+|$)/,_paragraph:/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html| +\n)[^\n]+)*)/,text:/^[^\n]+/,_label:/(?!\s*\])(?:\\[\[\]]|[^\[\]])+/,_title:/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/};x.def=O(x.def).replace("label",x._label).replace("title",x._title).getRegex(),x.bullet=/(?:[*+-]|\d{1,9}[.)])/,x.item=/^( *)(bull) ?[^\n]*(?:\n(?! *bull ?)[^\n]*)*/,x.item=O(x.item,"gm").replace(/bull/g,x.bullet).getRegex(),x.listItemStart=O(/^( *)(bull) */).replace("bull",x.bullet).getRegex(),x.list=O(x.list).replace(/bull/g,x.bullet).replace("hr","\\n+(?=\\1?(?:(?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$))").replace("def","\\n+(?="+x.def.source+")").getRegex(),x._tag="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|section|source|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",x._comment=/<!--(?!-?>)[\s\S]*?(?:-->|$)/,x.html=O(x.html,"i").replace("comment",x._comment).replace("tag",x._tag).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),x.paragraph=O(x._paragraph).replace("hr",x.hr).replace("heading"," {0,3}#{1,6} ").replace("|lheading","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|!--)").replace("tag",x._tag).getRegex(),x.blockquote=O(x.blockquote).replace("paragraph",x.paragraph).getRegex(),x.normal=w({},x),x.gfm=w({},x.normal,{nptable:"^ *([^|\\n ].*\\|.*)\\n {0,3}([-:]+ *\\|[-| :]*)(?:\\n((?:(?!\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)",table:"^ *\\|(.+)\\n {0,3}\\|?( *[-:]+[-| :]*)(?:\\n *((?:(?!\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)"}),x.gfm.nptable=O(x.gfm.nptable).replace("hr",x.hr).replace("heading"," {0,3}#{1,6} ").replace("blockquote"," {0,3}>").replace("code"," {4}[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|!--)").replace("tag",x._tag).getRegex(),x.gfm.table=O(x.gfm.table).replace("hr",x.hr).replace("heading"," {0,3}#{1,6} ").replace("blockquote"," {0,3}>").replace("code"," {4}[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|!--)").replace("tag",x._tag).getRegex(),x.pedantic=w({},x.normal,{html:O("^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:\"[^\"]*\"|'[^']*'|\\s[^'\"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))").replace("comment",x._comment).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:q,paragraph:O(x.normal._paragraph).replace("hr",x.hr).replace("heading"," *#{1,6} *[^\n]").replace("lheading",x.lheading).replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").getRegex()});q={escape:/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,autolink:/^<(scheme:[^\s\x00-\x1f<>]*|email)>/,url:q,tag:"^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>",link:/^!?\[(label)\]\(\s*(href)(?:\s+(title))?\s*\)/,reflink:/^!?\[(label)\]\[(?!\s*\])((?:\\[\[\]]?|[^\[\]\\])+)\]/,nolink:/^!?\[(?!\s*\])((?:\[[^\[\]]*\]|\\[\[\]]|[^\[\]])*)\](?:\[\])?/,reflinkSearch:"reflink|nolink(?!\\()",emStrong:{lDelim:/^(?:\*+(?:([punct_])|[^\s*]))|^_+(?:([punct*])|([^\s_]))/,rDelimAst:/\_\_[^_]*?\*[^_]*?\_\_|[punct_](\*+)(?=[\s]|$)|[^punct*_\s](\*+)(?=[punct_\s]|$)|[punct_\s](\*+)(?=[^punct*_\s])|[\s](\*+)(?=[punct_])|[punct_](\*+)(?=[punct_])|[^punct*_\s](\*+)(?=[^punct*_\s])/,rDelimUnd:/\*\*[^*]*?\_[^*]*?\*\*|[punct*](\_+)(?=[\s]|$)|[^punct*_\s](\_+)(?=[punct*\s]|$)|[punct*\s](\_+)(?=[^punct*_\s])|[\s](\_+)(?=[punct*])|[punct*](\_+)(?=[punct*])/},code:/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,br:/^( {2,}|\\)\n(?!\s*$)/,del:q,text:/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,punctuation:/^([\spunctuation])/,_punctuation:"!\"#$%&'()+\\-.,/:;<=>?@\\[\\]`^{|}~"};q.punctuation=O(q.punctuation).replace(/punctuation/g,q._punctuation).getRegex(),q.blockSkip=/\[[^\]]*?\]\([^\)]*?\)|`[^`]*?`|<[^>]*?>/g,q.escapedEmSt=/\\\*|\\_/g,q._comment=O(x._comment).replace("(?:--\x3e|$)","--\x3e").getRegex(),q.emStrong.lDelim=O(q.emStrong.lDelim).replace(/punct/g,q._punctuation).getRegex(),q.emStrong.rDelimAst=O(q.emStrong.rDelimAst,"g").replace(/punct/g,q._punctuation).getRegex(),q.emStrong.rDelimUnd=O(q.emStrong.rDelimUnd,"g").replace(/punct/g,q._punctuation).getRegex(),q._escapes=/\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/g,q._scheme=/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/,q._email=/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/,q.autolink=O(q.autolink).replace("scheme",q._scheme).replace("email",q._email).getRegex(),q._attribute=/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/,q.tag=O(q.tag).replace("comment",q._comment).replace("attribute",q._attribute).getRegex(),q._label=/(?:\[(?:\\.|[^\[\]\\])*\]|\\.|`[^`]*`|[^\[\]\\`])*?/,q._href=/<(?:\\.|[^\n<>\\])+>|[^\s\x00-\x1f]*/,q._title=/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/,q.link=O(q.link).replace("label",q._label).replace("href",q._href).replace("title",q._title).getRegex(),q.reflink=O(q.reflink).replace("label",q._label).getRegex(),q.reflinkSearch=O(q.reflinkSearch,"g").replace("reflink",q.reflink).replace("nolink",q.nolink).getRegex(),q.normal=w({},q),q.pedantic=w({},q.normal,{strong:{start:/^__|\*\*/,middle:/^__(?=\S)([\s\S]*?\S)__(?!_)|^\*\*(?=\S)([\s\S]*?\S)\*\*(?!\*)/,endAst:/\*\*(?!\*)/g,endUnd:/__(?!_)/g},em:{start:/^_|\*/,middle:/^()\*(?=\S)([\s\S]*?\S)\*(?!\*)|^_(?=\S)([\s\S]*?\S)_(?!_)/,endAst:/\*(?!\*)/g,endUnd:/_(?!_)/g},link:O(/^!?\[(label)\]\((.*?)\)/).replace("label",q._label).getRegex(),reflink:O(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",q._label).getRegex()}),q.gfm=w({},q.normal,{escape:O(q.escape).replace("])","~|])").getRegex(),_extended_email:/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/,url:/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,_backpedal:/(?:[^?!.,:;*_~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])([\s\S]*?[^\s~])\1(?=[^~]|$)/,text:/^([`~]+|[^`~])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@))|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@))/}),q.gfm.url=O(q.gfm.url,"i").replace("email",q.gfm._extended_email).getRegex(),q.breaks=w({},q.gfm,{br:O(q.br).replace("{2,}","*").getRegex(),text:O(q.gfm.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()});var q={block:x,inline:q},j=u.defaults,U=q.block,P=q.inline,L=_;function M(e){return e.replace(/---/g,"—").replace(/--/g,"–").replace(/(^|[-\u2014/(\[{"\s])'/g,"$1‘").replace(/'/g,"’").replace(/(^|[-\u2014/(\[{\u2018\s])"/g,"$1“").replace(/"/g,"”").replace(/\.{3}/g,"…")}function N(e){for(var u,t="",n=e.length,r=0;r<n;r++)u=e.charCodeAt(r),t+="&#"+(u=.5<Math.random()?"x"+u.toString(16):u)+";";return t}var X=function(){function t(e){this.tokens=[],this.tokens.links=Object.create(null),this.options=e||j,this.options.tokenizer=this.options.tokenizer||new Z,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options;e={block:U.normal,inline:P.normal};this.options.pedantic?(e.block=U.pedantic,e.inline=P.pedantic):this.options.gfm&&(e.block=U.gfm,this.options.breaks?e.inline=P.breaks:e.inline=P.gfm),this.tokenizer.rules=e}t.lex=function(e,u){return new t(u).lex(e)},t.lexInline=function(e,u){return new t(u).inlineTokens(e)};var e,u,n=t.prototype;return n.lex=function(e){return e=e.replace(/\r\n|\r/g,"\n").replace(/\t/g,"    "),this.blockTokens(e,this.tokens,!0),this.inline(this.tokens),this.tokens},n.blockTokens=function(e,u,t){var n,r,i,s;for(void 0===u&&(u=[]),void 0===t&&(t=!0),this.options.pedantic&&(e=e.replace(/^ +$/gm,""));e;)if(n=this.tokenizer.space(e))e=e.substring(n.raw.length),n.type&&u.push(n);else if(n=this.tokenizer.code(e))e=e.substring(n.raw.length),(s=u[u.length-1])&&"paragraph"===s.type?(s.raw+="\n"+n.raw,s.text+="\n"+n.text):u.push(n);else if(n=this.tokenizer.fences(e))e=e.substring(n.raw.length),u.push(n);else if(n=this.tokenizer.heading(e))e=e.substring(n.raw.length),u.push(n);else if(n=this.tokenizer.nptable(e))e=e.substring(n.raw.length),u.push(n);else if(n=this.tokenizer.hr(e))e=e.substring(n.raw.length),u.push(n);else if(n=this.tokenizer.blockquote(e))e=e.substring(n.raw.length),n.tokens=this.blockTokens(n.text,[],t),u.push(n);else if(n=this.tokenizer.list(e)){for(e=e.substring(n.raw.length),i=n.items.length,r=0;r<i;r++)n.items[r].tokens=this.blockTokens(n.items[r].text,[],!1);u.push(n)}else if(n=this.tokenizer.html(e))e=e.substring(n.raw.length),u.push(n);else if(t&&(n=this.tokenizer.def(e)))e=e.substring(n.raw.length),this.tokens.links[n.tag]||(this.tokens.links[n.tag]={href:n.href,title:n.title});else if(n=this.tokenizer.table(e))e=e.substring(n.raw.length),u.push(n);else if(n=this.tokenizer.lheading(e))e=e.substring(n.raw.length),u.push(n);else if(t&&(n=this.tokenizer.paragraph(e)))e=e.substring(n.raw.length),u.push(n);else if(n=this.tokenizer.text(e))e=e.substring(n.raw.length),(s=u[u.length-1])&&"text"===s.type?(s.raw+="\n"+n.raw,s.text+="\n"+n.text):u.push(n);else if(e){var l="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(l);break}throw new Error(l)}return u},n.inline=function(e){for(var u,t,n,r,i,s=e.length,l=0;l<s;l++)switch((i=e[l]).type){case"paragraph":case"text":case"heading":i.tokens=[],this.inlineTokens(i.text,i.tokens);break;case"table":for(i.tokens={header:[],cells:[]},n=i.header.length,u=0;u<n;u++)i.tokens.header[u]=[],this.inlineTokens(i.header[u],i.tokens.header[u]);for(n=i.cells.length,u=0;u<n;u++)for(r=i.cells[u],i.tokens.cells[u]=[],t=0;t<r.length;t++)i.tokens.cells[u][t]=[],this.inlineTokens(r[t],i.tokens.cells[u][t]);break;case"blockquote":this.inline(i.tokens);break;case"list":for(n=i.items.length,u=0;u<n;u++)this.inline(i.items[u].tokens)}return e},n.inlineTokens=function(e,u,t,n){var r;void 0===u&&(u=[]),void 0===t&&(t=!1),void 0===n&&(n=!1);var i,s,l,a=e;if(this.tokens.links){var D=Object.keys(this.tokens.links);if(0<D.length)for(;null!=(i=this.tokenizer.rules.inline.reflinkSearch.exec(a));)D.includes(i[0].slice(i[0].lastIndexOf("[")+1,-1))&&(a=a.slice(0,i.index)+"["+L("a",i[0].length-2)+"]"+a.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;null!=(i=this.tokenizer.rules.inline.blockSkip.exec(a));)a=a.slice(0,i.index)+"["+L("a",i[0].length-2)+"]"+a.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);for(;null!=(i=this.tokenizer.rules.inline.escapedEmSt.exec(a));)a=a.slice(0,i.index)+"++"+a.slice(this.tokenizer.rules.inline.escapedEmSt.lastIndex);for(;e;)if(s||(l=""),s=!1,r=this.tokenizer.escape(e))e=e.substring(r.raw.length),u.push(r);else if(r=this.tokenizer.tag(e,t,n)){e=e.substring(r.raw.length),t=r.inLink,n=r.inRawBlock;var o=u[u.length-1];o&&"text"===r.type&&"text"===o.type?(o.raw+=r.raw,o.text+=r.text):u.push(r)}else if(r=this.tokenizer.link(e))e=e.substring(r.raw.length),"link"===r.type&&(r.tokens=this.inlineTokens(r.text,[],!0,n)),u.push(r);else if(r=this.tokenizer.reflink(e,this.tokens.links)){e=e.substring(r.raw.length);o=u[u.length-1];"link"===r.type?(r.tokens=this.inlineTokens(r.text,[],!0,n),u.push(r)):o&&"text"===r.type&&"text"===o.type?(o.raw+=r.raw,o.text+=r.text):u.push(r)}else if(r=this.tokenizer.emStrong(e,a,l))e=e.substring(r.raw.length),r.tokens=this.inlineTokens(r.text,[],t,n),u.push(r);else if(r=this.tokenizer.codespan(e))e=e.substring(r.raw.length),u.push(r);else if(r=this.tokenizer.br(e))e=e.substring(r.raw.length),u.push(r);else if(r=this.tokenizer.del(e))e=e.substring(r.raw.length),r.tokens=this.inlineTokens(r.text,[],t,n),u.push(r);else if(r=this.tokenizer.autolink(e,N))e=e.substring(r.raw.length),u.push(r);else if(t||!(r=this.tokenizer.url(e,N))){if(r=this.tokenizer.inlineText(e,n,M))e=e.substring(r.raw.length),"_"!==r.raw.slice(-1)&&(l=r.raw.slice(-1)),s=!0,(c=u[u.length-1])&&"text"===c.type?(c.raw+=r.raw,c.text+=r.text):u.push(r);else if(e){var c="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(c);break}throw new Error(c)}}else e=e.substring(r.raw.length),u.push(r);return u},e=t,u=[{key:"rules",get:function(){return{block:U,inline:P}}}],(n=null)&&r(e.prototype,n),u&&r(e,u),t}(),G=u.defaults,V=B,H=m,J=function(){function e(e){this.options=e||G}var u=e.prototype;return u.code=function(e,u,t){var n=(u||"").match(/\S*/)[0];return!this.options.highlight||null!=(u=this.options.highlight(e,n))&&u!==e&&(t=!0,e=u),e=e.replace(/\n$/,"")+"\n",n?'<pre><code class="'+this.options.langPrefix+H(n,!0)+'">'+(t?e:H(e,!0))+"</code></pre>\n":"<pre><code>"+(t?e:H(e,!0))+"</code></pre>\n"},u.blockquote=function(e){return"<blockquote>\n"+e+"</blockquote>\n"},u.html=function(e){return e},u.heading=function(e,u,t,n){return this.options.headerIds?"<h"+u+' id="'+this.options.headerPrefix+n.slug(t)+'">'+e+"</h"+u+">\n":"<h"+u+">"+e+"</h"+u+">\n"},u.hr=function(){return this.options.xhtml?"<hr/>\n":"<hr>\n"},u.list=function(e,u,t){var n=u?"ol":"ul";return"<"+n+(u&&1!==t?' start="'+t+'"':"")+">\n"+e+"</"+n+">\n"},u.listitem=function(e){return"<li>"+e+"</li>\n"},u.checkbox=function(e){return"<input "+(e?'checked="" ':"")+'disabled="" type="checkbox"'+(this.options.xhtml?" /":"")+"> "},u.paragraph=function(e){return"<p>"+e+"</p>\n"},u.table=function(e,u){return"<table>\n<thead>\n"+e+"</thead>\n"+(u=u&&"<tbody>"+u+"</tbody>")+"</table>\n"},u.tablerow=function(e){return"<tr>\n"+e+"</tr>\n"},u.tablecell=function(e,u){var t=u.header?"th":"td";return(u.align?"<"+t+' align="'+u.align+'">':"<"+t+">")+e+"</"+t+">\n"},u.strong=function(e){return"<strong>"+e+"</strong>"},u.em=function(e){return"<em>"+e+"</em>"},u.codespan=function(e){return"<code>"+e+"</code>"},u.br=function(){return this.options.xhtml?"<br/>":"<br>"},u.del=function(e){return"<del>"+e+"</del>"},u.link=function(e,u,t){if(null===(e=V(this.options.sanitize,this.options.baseUrl,e)))return t;e='<a href="'+H(e)+'"';return u&&(e+=' title="'+u+'"'),e+=">"+t+"</a>"},u.image=function(e,u,t){if(null===(e=V(this.options.sanitize,this.options.baseUrl,e)))return t;t='<img src="'+e+'" alt="'+t+'"';return u&&(t+=' title="'+u+'"'),t+=this.options.xhtml?"/>":">"},u.text=function(e){return e},e}(),K=function(){function e(){}var u=e.prototype;return u.strong=function(e){return e},u.em=function(e){return e},u.codespan=function(e){return e},u.del=function(e){return e},u.html=function(e){return e},u.text=function(e){return e},u.link=function(e,u,t){return""+t},u.image=function(e,u,t){return""+t},u.br=function(){return""},e}(),Q=function(){function e(){this.seen={}}var u=e.prototype;return u.serialize=function(e){return e.toLowerCase().trim().replace(/<[!\/a-z].*?>/gi,"").replace(/[\u2000-\u206F\u2E00-\u2E7F\\'!"#$%&()*+,./:;<=>?@[\]^`{|}~]/g,"").replace(/\s/g,"-")},u.getNextSafeSlug=function(e,u){var t=e,n=0;if(this.seen.hasOwnProperty(t))for(n=this.seen[e];t=e+"-"+ ++n,this.seen.hasOwnProperty(t););return u||(this.seen[e]=n,this.seen[t]=0),t},u.slug=function(e,u){void 0===u&&(u={});var t=this.serialize(e);return this.getNextSafeSlug(t,u.dryrun)},e}(),W=u.defaults,Y=b,ee=function(){function t(e){this.options=e||W,this.options.renderer=this.options.renderer||new J,this.renderer=this.options.renderer,this.renderer.options=this.options,this.textRenderer=new K,this.slugger=new Q}t.parse=function(e,u){return new t(u).parse(e)},t.parseInline=function(e,u){return new t(u).parseInline(e)};var e=t.prototype;return e.parse=function(e,u){void 0===u&&(u=!0);for(var t,n,r,i,s,l,a,D,o,c,h,p,g,f,F,A="",C=e.length,d=0;d<C;d++)switch((D=e[d]).type){case"space":continue;case"hr":A+=this.renderer.hr();continue;case"heading":A+=this.renderer.heading(this.parseInline(D.tokens),D.depth,Y(this.parseInline(D.tokens,this.textRenderer)),this.slugger);continue;case"code":A+=this.renderer.code(D.text,D.lang,D.escaped);continue;case"table":for(l=o="",r=D.header.length,t=0;t<r;t++)l+=this.renderer.tablecell(this.parseInline(D.tokens.header[t]),{header:!0,align:D.align[t]});for(o+=this.renderer.tablerow(l),a="",r=D.cells.length,t=0;t<r;t++){for(l="",i=(s=D.tokens.cells[t]).length,n=0;n<i;n++)l+=this.renderer.tablecell(this.parseInline(s[n]),{header:!1,align:D.align[n]});a+=this.renderer.tablerow(l)}A+=this.renderer.table(o,a);continue;case"blockquote":a=this.parse(D.tokens),A+=this.renderer.blockquote(a);continue;case"list":for(o=D.ordered,E=D.start,c=D.loose,r=D.items.length,a="",t=0;t<r;t++)g=(p=D.items[t]).checked,f=p.task,h="",p.task&&(F=this.renderer.checkbox(g),c?0<p.tokens.length&&"text"===p.tokens[0].type?(p.tokens[0].text=F+" "+p.tokens[0].text,p.tokens[0].tokens&&0<p.tokens[0].tokens.length&&"text"===p.tokens[0].tokens[0].type&&(p.tokens[0].tokens[0].text=F+" "+p.tokens[0].tokens[0].text)):p.tokens.unshift({type:"text",text:F}):h+=F),h+=this.parse(p.tokens,c),a+=this.renderer.listitem(h,f,g);A+=this.renderer.list(a,o,E);continue;case"html":A+=this.renderer.html(D.text);continue;case"paragraph":A+=this.renderer.paragraph(this.parseInline(D.tokens));continue;case"text":for(a=D.tokens?this.parseInline(D.tokens):D.text;d+1<C&&"text"===e[d+1].type;)a+="\n"+((D=e[++d]).tokens?this.parseInline(D.tokens):D.text);A+=u?this.renderer.paragraph(a):a;continue;default:var E='Token with "'+D.type+'" type was not found.';if(this.options.silent)return void console.error(E);throw new Error(E)}return A},e.parseInline=function(e,u){u=u||this.renderer;for(var t,n="",r=e.length,i=0;i<r;i++)switch((t=e[i]).type){case"escape":n+=u.text(t.text);break;case"html":n+=u.html(t.text);break;case"link":n+=u.link(t.href,t.title,this.parseInline(t.tokens,u));break;case"image":n+=u.image(t.href,t.title,t.text);break;case"strong":n+=u.strong(this.parseInline(t.tokens,u));break;case"em":n+=u.em(this.parseInline(t.tokens,u));break;case"codespan":n+=u.codespan(t.text);break;case"br":n+=u.br();break;case"del":n+=u.del(this.parseInline(t.tokens,u));break;case"text":n+=u.text(t.text);break;default:var s='Token with "'+t.type+'" type was not found.';if(this.options.silent)return void console.error(s);throw new Error(s)}return n},t}(),ue=v,te=y,ne=m,m=u.getDefaults,re=u.changeDefaults,u=u.defaults;function ie(e,t,n){if(null==e)throw new Error("marked(): input parameter is undefined or null");if("string"!=typeof e)throw new Error("marked(): input parameter is of type "+Object.prototype.toString.call(e)+", string expected");if("function"==typeof t&&(n=t,t=null),t=ue({},ie.defaults,t||{}),te(t),n){var r,i=t.highlight;try{r=X.lex(e,t)}catch(e){return n(e)}var s=function(u){var e;if(!u)try{e=ee.parse(r,t)}catch(e){u=e}return t.highlight=i,u?n(u):n(null,e)};if(!i||i.length<3)return s();if(delete t.highlight,!r.length)return s();var l=0;return ie.walkTokens(r,function(t){"code"===t.type&&(l++,setTimeout(function(){i(t.text,t.lang,function(e,u){return e?s(e):(null!=u&&u!==t.text&&(t.text=u,t.escaped=!0),void(0===--l&&s()))})},0))}),void(0===l&&s())}try{var u=X.lex(e,t);return t.walkTokens&&ie.walkTokens(u,t.walkTokens),ee.parse(u,t)}catch(e){if(e.message+="\nPlease report this to https://github.com/markedjs/marked.",t.silent)return"<p>An error occurred:</p><pre>"+ne(e.message+"",!0)+"</pre>";throw e}}return ie.options=ie.setOptions=function(e){return ue(ie.defaults,e),re(ie.defaults),ie},ie.getDefaults=m,ie.defaults=u,ie.use=function(l){var u,t=ue({},l);l.renderer&&function(){var e,s=ie.defaults.renderer||new J;for(e in l.renderer)!function(r){var i=s[r];s[r]=function(){for(var e=arguments.length,u=new Array(e),t=0;t<e;t++)u[t]=arguments[t];var n=l.renderer[r].apply(s,u);return n=!1===n?i.apply(s,u):n}}(e);t.renderer=s}(),l.tokenizer&&function(){var e,s=ie.defaults.tokenizer||new Z;for(e in l.tokenizer)!function(r){var i=s[r];s[r]=function(){for(var e=arguments.length,u=new Array(e),t=0;t<e;t++)u[t]=arguments[t];var n=l.tokenizer[r].apply(s,u);return n=!1===n?i.apply(s,u):n}}(e);t.tokenizer=s}(),l.walkTokens&&(u=ie.defaults.walkTokens,t.walkTokens=function(e){l.walkTokens(e),u&&u(e)}),ie.setOptions(t)},ie.walkTokens=function(e,u){for(var t,n=c(e);!(t=n()).done;){var r=t.value;switch(u(r),r.type){case"table":for(var i=c(r.tokens.header);!(s=i()).done;){var s=s.value;ie.walkTokens(s,u)}for(var l,a=c(r.tokens.cells);!(l=a()).done;)for(var D=c(l.value);!(o=D()).done;){var o=o.value;ie.walkTokens(o,u)}break;case"list":ie.walkTokens(r.items,u);break;default:r.tokens&&ie.walkTokens(r.tokens,u)}}},ie.parseInline=function(e,u){if(null==e)throw new Error("marked.parseInline(): input parameter is undefined or null");if("string"!=typeof e)throw new Error("marked.parseInline(): input parameter is of type "+Object.prototype.toString.call(e)+", string expected");u=ue({},ie.defaults,u||{}),te(u);try{var t=X.lexInline(e,u);return u.walkTokens&&ie.walkTokens(t,u.walkTokens),ee.parseInline(t,u)}catch(e){if(e.message+="\nPlease report this to https://github.com/markedjs/marked.",u.silent)return"<p>An error occurred:</p><pre>"+ne(e.message+"",!0)+"</pre>";throw e}},ie.Parser=ee,ie.parser=ee.parse,ie.Renderer=J,ie.TextRenderer=K,ie.Lexer=X,ie.lexer=X.lex,ie.Tokenizer=Z,ie.Slugger=Q,ie.parse=ie});
                /** end of marked code */
                return marked(md_data);
            }
            function downloadURI(uri,name){
                var link = document.createElement("a");
                link.download = name;
                link.href = uri;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                delete link;
            }
            function PAGE_isMobile(){
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }
            function PAGE_key_set(key,action){
                //key: key name or 'CTRL_<keyname>'
                // action== true: system default
                // action== false: disable
                // action== callback: this function will be triggered by ctrl+s
                if(window.PAGE_keys==undefined){
                    window.PAGE_keys={'single':{},'CTRL':{}};
                    document.addEventListener('keyup',function(e){if(!e.ctrlKey){if(window.PAGE_keys.single.hasOwnProperty(e.key)){window.PAGE_keys.single[e.key](e);}}});
                    document.addEventListener('keydown',function(e){if(e.ctrlKey){if(window.PAGE_keys.CTRL.hasOwnProperty(e.key)){window.PAGE_keys.CTRL[e.key](e);}}});
                }
                if(key.startsWith("CTRL_")){
                    key=key.substring(5);
                    switch(action){
                        case true:if(window.PAGE_keys.CTRL[key]!==undefined){delete window.PAGE_keys.CTRL[key];};break;
                        case false:window.PAGE_keys.CTRL[key]=function(e){e.preventDefault();return false;};break;
                        default:window.PAGE_keys.CTRL[key]=function(e){e.preventDefault();action();return false;};
                    }
                }
                else{
                    switch(action){
                        case true:if(window.PAGE_keys.single[key]!==undefined){delete window.PAGE_keys.single[key];};break;
                        case false:window.PAGE_keys.single[key]=function(e){e.preventDefault();return false;};break;
                        default:window.PAGE_keys.single[key]=function(e){e.preventDefault();action();return false;}
                    }
                }
            }
            function PAGE_change_favicon(icon){
                var link = document.querySelector("link[rel*='icon']") || document.createElement('link');
                link.rel = 'icon';
                link.href = icon;
                document.getElementsByTagName('head')[0].appendChild(link);
            }
            function PAGE_change_title(title){
                document.title = title;
            }
            function PAGE_alert(HTMLContent){
                var HTML='';
                HTML=HTML+'<div id="modal-one" style="z-index:100;position:fixed;width:100vw;height:100vh;visibility: visible;opacity: 1;transition-delay: 0s;transition: all 0.3s ease;top:0;left:0;display:flex;align-items:center;justify-content: center;">';
                HTML=HTML+'  <div style="position:absolute;background:gray;width:100%;height:100%;opacity: 0.5;" onclick="function(e){e.preventDefault();e.stopPropagation();}"></div>';
                HTML=HTML+'  <div style="border-radius: 10px;background: #fff;position: relative;padding: 30px;">';
                HTML=HTML+'    <h1>Amazing Modal</h1>';
                HTML=HTML+'    <h2>Pure Vanilla JavaScript</h2>';
                HTML=HTML+'    <button style="position: absolute;right: 15px;top: 15px;outline: none;appearance: none;color: red;background: none;border: 0px;font-weight: bold;cursor: pointer;">X</button>';
                HTML=HTML+'  </div>';
                HTML=HTML+'</div>'; 
                document.body.insertAdjacentHTML('beforeend', HTML);
console.log('hereee');
            }
            // JS utilities                
            function str2HTML(str_data){//
                // 1: Plain Text Search
                //var text = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/ /g, "&nbsp;<wbr>");//this is a bit extremistic: keep the accurate number of spaces to preserve the reference, yet make it wrappable
                var text = str_data.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                // 2: Line Breaks
                text = text.replace(/\r\n?|\n/g, "<br>");
                // 3: Paragraphs
                //text = text.replace(/<br>\s*<br>/g, "</p><p>");
                return text;
            }
            function stringsize(str){//returns the bit size of a string
                return encodeURI(str).split(/%..|./).length - 1;
            }
            function normalize(text){//removes diatrics
                return text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            }
            function bytesToHumansize(size){
                //note: filesize is in bytes
                //note this function counts in SI (1000 not 1024)
                if(Math.abs(size) < 1000){return size + ' B';}
                var units = ['kB','MB','GB','TB','PB','EB','ZB','YB'];
                var u = -1;
                do{size /= 1000;++u;}
                while(Math.abs(size) >= 1000 && u < units.length - 1);
                return size.toFixed(1)+' '+units[u];
            }
            function exit(message){
                // derived from:
                // http://kevin.vanzonneveld.net
                // +   original by: Brett Zamir (http://brettz9.blogspot.com)
                // +      input by: Paul
                // +   bugfixed by: Hyam Singer (http://www.impact-computing.com/)
                // +   improved by: Philip Peterson
                // +   bugfixed by: Brett Zamir (http://brettz9.blogspot.com)
                // %        note 1: Should be considered expirimental. Please comment on this function.
                // *     example 1: exit();
                // *     returns 1: null
                document.body.innerText=message;
                window.addEventListener('error', function (e) {e.preventDefault();e.stopPropagation();}, false);
                var handlers = ['copy','cut','paste','beforeunload','blur','change','click','contextmenu','dblclick','focus','keydown','keypress','keyup','mousedown','mousemove','mouseout','mouseover','mouseup','resize','scroll','DOMNodeInserted','DOMNodeRemoved','DOMNodeRemovedFromDocument','DOMNodeInsertedIntoDocument','DOMAttrModified','DOMCharacterDataModified','DOMElementNameChanged','DOMAttributeNameChanged','DOMActivate','DOMFocusIn','DOMFocusOut','online','offline','textInput','abort','close','dragdrop','load','paint','reset','select','submit','unload'];
                var i;for(i=0;i<handlers.length;i++){window.addEventListener(handlers[i],function(e){e.stopPropagation();e.preventDefault();},true);}
                if(window.stop){window.stop();}
                throw '';
            }
            function DATE_getTimestamp14(date){
                // return a 14 digits timestamp
                return ('0'+date.getTime().toString()).slice(-14);
            }
            function DATE_getHumanDateFormat(date,cut){
                // returns local time string  (12:00 in Paris)
                // cut=undefined => 2020-10-10 12:00:24.123
                // cut=16        => 2020-10-10 12:00
                // cut=10        => 2020-10-10
                if(date==undefined){date=new Date();}
                var str=new Date(date.getTime()-(date.getTimezoneOffset()*60000)).toISOString().replace('T',' ').slice(0,-1);
                if(cut!=undefined){str=str.slice(0,cut);}
                return str;
            }
            function DATE_setHumanDateFormat(str){
                //returns null if could not find a date
                //returns a jsdate otherwise
                var date = new Date(Date.parse(str));
                var jsTime=date.getTime();
                if(isNaN(jsTime)){return null;}
                else{return date;}
            }
            function DATE_getIsoUtcFormat(date){
                //local ISOTime string at UTC
                // ex: 2020-10-10T10:00:24.123Z   (12:00 in Paris)
                if(date==undefined){date=new Date();}
                return date.toISOString();
            }
            function DATE_getIsoLocalFormat(date){
                //local ISOTime string without qualifier
                // ex: 2020-10-10T12:00:24.123   (12:00 in Paris)
                if(date==undefined){date=new Date();}
                return new Date(date.getTime()-(date.getTimezoneOffset()*60000)).toISOString().slice(0,-1);
            }
            function DATE_getIsoWtzFormat(date){
                //local ISOTime string with timezone
                // ex: 2020-10-10T12:00:24.123+2.00   (12:00 in Paris)
                if(date==undefined){date=new Date();}
                //solution thanks to https://stackoverflow.com/questions/17415579/how-to-iso-8601-format-a-date-with-timezone-offset-in-javascript (2020-10-10) / @MattJohnson
                var tzo = -date.getTimezoneOffset(),
                dif = tzo >= 0 ? '+' : '-',
                pad = function(num){var norm = Math.floor(Math.abs(num));return (norm < 10 ? '0' : '') + norm;};
                return date.getFullYear()+'-'+pad(date.getMonth()+1)+'-'+pad(date.getDate())+'T'+pad(date.getHours())+':'+pad(date.getMinutes())+':'+pad(date.getSeconds())+'.'+pad(date.getMilliseconds())+dif+pad(tzo/60)+':'+pad(tzo%60);
            }

        </script>
    </head>
    <body>
        <div id='DB'>
            <table id='DB_filter'>
                <thead>
                    <tr>
                    <td id='DB_filter_mainMenu'>≡</td>
                    <td id='DB_filter_in' colspan='4'>
                        <table id='DB_filter_input'>
                        <tr>
                            <td id='DB_filter_input_text'><input id='DB_filter_input_text_INPUT' type='text' placeholder='Search...' autocomplete='off' /></td>
                            <td id='DB_filter_input_clear'>✖</td>
                        </tr>
                    </table>
                    </td>
                    </tr>
                </thead>
                <tbody id='DB_filter_mainMenuContent'>
                    <tr>
                    <td id='DB_filter_dateUpTo'>select</td>
                    <td id='DB_filter_📷'>📷</td>
                    <td id='DB_filter_🎬'>🎬</td>
                    <td id='DB_filter_🎵'>🎵</td>
                    <td id='DB_filter_�'>�</td>
                    </tr>
                    <tr>
                    <td id='DB_filter_sortWay'>Wait...</td>
                    <td id='DB_filter_📄'>📄</td>
                    <td id='DB_filter_📧'>📧</td>
                    <td id='DB_filter_📦'>📦</td>
                    <td id='DB_filter_💻'>💻</td>
                    </tr>
                    <tr>
                    <td id='DB_filter_extraMenu'>#</td>
                    <td id='DB_filter_👤'>👤</td>
                    <td id='DB_filter_📆'>📆</td>
                    <td id='DB_filter_🔗'>🔗</td>
                    <td id='DB_filter_📝'>📝</td>
                    </tr>
                </tbody>
                <tbody id='DB_filter_plugins'>
                </tbody>
            </table>
            <div id='DB_lists'>
                <div id='DB_lists_reminders'></div>
                <div id='DB_lists_desktop'></div>
                <div id='DB_lists_archives'></div>
            </div>
            <div id='DB_footer'><div class='DB_footer_bounce1'></div><div class='DB_footer_bounce2'></div><div class='DB_footer_bounce3'></div></div>
        </div>
        <div id='UPLOADER'>
        </div>
        <div id='VIEWER'>
            <div id='VIEWER_menu'>
                <div id='VIEWER_menu_main'>
                    <div id='VIEWER_menu_main_filename'></div>
                    <div id='VIEWER_menu_main_filedate'></div>
                </div>
                <div id='VIEWER_menu_actions'>☰</div>
                <div id='VIEWER_menu_close'>✕</div>
            </div>
            <div id='VIEWER_actions'></div>
            <div id='VIEWER_content'></div>
        </div>
        <div id='EDITOR'>
            <div id='EDITOR_menu'>
                <div id='EDITOR_menu_filename'><input id='EDITOR_menu_filename_textInput' type='text' /></div>
                <div id='EDITOR_menu_save'>💾</div>
                <div id='EDITOR_menu_delete'>🗑️</div>
                <div id='EDITOR_menu_close'>✕</div>
            </div>
            <div id='EDITOR_content'></div>
        </div>
    </body>
</html>
